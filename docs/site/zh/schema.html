<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Schema - MiniCPM-o 4.5 文档</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">
<style>
* { margin:0; padding:0; box-sizing:border-box; }
:root {
  --sidebar-w: 260px;
  --bg: #fff; --bg-side: #f8f9fa; --bg-code: #f6f8fa;
  --c1: #24292f; --c2: #57606a;
  --border: #d0d7de; --accent: #0969da; --nav-active: #ddf4ff;
}
body { font-family: -apple-system,BlinkMacSystemFont,"Segoe UI","Noto Sans",Helvetica,Arial,sans-serif; color:var(--c1); line-height:1.6; background:var(--bg); }
.sidebar-toggle { position:fixed; top:12px; left:12px; z-index:1001; background:var(--bg-side); border:1px solid var(--border); border-radius:6px; padding:6px 10px; font-size:18px; cursor:pointer; display:none; }
.sidebar { position:fixed; top:0; left:0; width:var(--sidebar-w); height:100vh; overflow-y:auto; background:var(--bg-side); border-right:1px solid var(--border); padding:20px 0; z-index:1000; transition:transform .3s; }
.sidebar-header { padding:0 20px 16px; border-bottom:1px solid var(--border); margin-bottom:8px; }
.sidebar-header h2 { font-size:16px; font-weight:600; }
.sidebar-subtitle { font-size:12px; color:var(--c2); }
.lang-switch { display:inline-block; margin-top:6px; font-size:12px; color:var(--accent); text-decoration:none; padding:2px 8px; border:1px solid var(--border); border-radius:4px; transition:background .15s; }
.lang-switch:hover { background:var(--nav-active); text-decoration:none; }

.nav-list { list-style:none; padding:0 8px; }
.nav-list > li > a { display:block; padding:7px 12px; color:var(--c2); text-decoration:none; font-size:14px; border-radius:6px; transition:background .15s,color .15s; }
.nav-list > li > a:hover { background:#e8e8e8; color:var(--c1); }
.nav-list > li > a.active { background:var(--nav-active); color:var(--accent); font-weight:600; }

.nav-group { margin-top:4px; }
.nav-group-header { display:flex; align-items:center; gap:6px; padding:8px 12px; color:var(--c1); font-size:12px; font-weight:700; text-transform:uppercase; letter-spacing:.04em; cursor:pointer; border-radius:6px; user-select:none; transition:background .15s; }
.nav-group-header:hover { background:#eaeef2; }
.nav-group-header::before { content:""; display:inline-block; width:0; height:0; border-left:5px solid var(--c2); border-top:3.5px solid transparent; border-bottom:3.5px solid transparent; transition:transform .2s; transform:rotate(90deg); flex-shrink:0; }
.nav-group.collapsed .nav-group-header::before { transform:rotate(0); }
.nav-group-children { list-style:none; margin:0 0 4px 19px; padding:3px 0 3px 13px; border-left:2px solid #e1e4e8; overflow:hidden; max-height:500px; transition:max-height .25s ease,opacity .2s ease,padding .2s ease; opacity:1; }
.nav-group.collapsed .nav-group-children { max-height:0; opacity:0; padding:0 0 0 13px; }
.nav-group-children li a { display:block; padding:4px 10px; font-size:13px; color:var(--c2); text-decoration:none; border-radius:4px; transition:background .15s,color .15s; }
.nav-group-children li a:hover { background:#e8e8e8; color:var(--c1); }
.nav-group-children li a.active { background:var(--nav-active); color:var(--accent); font-weight:600; }

.content { margin-left:var(--sidebar-w); max-width:900px; padding:40px 48px; }
article h1 { font-size:28px; font-weight:600; padding-bottom:10px; border-bottom:1px solid var(--border); margin-bottom:20px; }
article h2 { font-size:22px; font-weight:600; margin-top:32px; margin-bottom:12px; padding-bottom:6px; border-bottom:1px solid #eaecef; }
article h3 { font-size:18px; font-weight:600; margin-top:24px; margin-bottom:10px; }
article h4 { font-size:15px; font-weight:600; margin-top:20px; margin-bottom:8px; }
article p { margin-bottom:14px; }
article ul,article ol { margin-bottom:14px; padding-left:24px; }
article li { margin-bottom:4px; }
article a { color:var(--accent); text-decoration:none; }
article a:hover { text-decoration:underline; }
article code { background:var(--bg-code); padding:2px 6px; border-radius:4px; font-size:13px; font-family:"SFMono-Regular",Consolas,"Liberation Mono",Menlo,monospace; }
article pre { background:var(--bg-code); border:1px solid var(--border); border-radius:6px; padding:16px; overflow-x:auto; margin-bottom:16px; line-height:1.5; }
article pre code { background:none; padding:0; font-size:13px; }
article table { width:100%; border-collapse:collapse; margin-bottom:16px; font-size:14px; }
article th,article td { border:1px solid var(--border); padding:8px 12px; text-align:left; }
article th { background:var(--bg-code); font-weight:600; }
article tr:nth-child(even) { background:#f8f9fa; }
article hr { border:none; border-top:1px solid var(--border); margin:28px 0; }
article blockquote { border-left:4px solid var(--accent); padding:8px 16px; margin:0 0 16px; color:var(--c2); background:#f8f9fa; border-radius:0 6px 6px 0; }
article .mermaid { text-align:center; margin:20px 0; }
footer { margin-top:60px; padding-top:16px; border-top:1px solid var(--border); color:var(--c2); font-size:13px; }
@media(max-width:768px) {
  .sidebar { transform:translateX(-100%); }
  .sidebar.open { transform:translateX(0); box-shadow:2px 0 8px rgba(0,0,0,.15); }
  .sidebar-toggle { display:block; }
  .content { margin-left:0; padding:50px 20px 40px; }
  .content.shifted { margin-left:var(--sidebar-w); }
}
</style>
</head>
<body>
<button class="sidebar-toggle" onclick="toggleSidebar()" aria-label="Toggle sidebar">&#9776;</button>
<nav class="sidebar" id="sidebar">
  <div class="sidebar-header">
    <h2>MiniCPM-o 4.5</h2>
    <span class="sidebar-subtitle">项目文档</span>
    <a href="../en/schema.html" class="lang-switch">English</a>
  </div>
  <ul class="nav-list">
    <li><a href="index.html">项目概述</a></li>
    <li class="nav-group">
      <span class="nav-group-header">系统架构</span>
      <ul class="nav-group-children">
        <li><a href="architecture/index.html">架构概述</a></li>
        <li><a href="architecture/streaming.html">Chat 模式</a></li>
        <li><a href="architecture/duplex.html">Duplex 模式</a></li>
        <li><a href="architecture/internals.html">内部机制</a></li>
      </ul>
    </li>
    <li><a href="gateway.html">Gateway 模块</a></li>
    <li><a href="worker.html">Worker 模块</a></li>
    <li><a href="schema.html" class="active">Schema</a></li>
    <li><a href="model.html">模型模块</a></li>
    <li><a href="compile.html">torch.compile</a></li>
    <li class="nav-group">
      <span class="nav-group-header">前端模块</span>
      <ul class="nav-group-children">
        <li><a href="frontend/index.html">前端概述</a></li>
        <li><a href="frontend/pages.html">页面与路由</a></li>
        <li><a href="frontend/audio.html">音频处理</a></li>
        <li><a href="frontend/duplex-session.html">双工会话</a></li>
        <li><a href="frontend/components.html">UI 组件</a></li>
      </ul>
    </li>
    <li><a href="api.html">API 参考</a></li>
    <li><a href="deployment.html">配置与部署</a></li>
  </ul>
</nav>
<main class="content" id="content">
  <article><h1 id="schema">Schema 与处理器</h1>
<p>本模块定义了系统的数据模型（Pydantic Schema）、统一处理器抽象和能力声明系统，是连接 Worker 服务层与底层模型的桥梁。</p>
<h2 id="_1">模块结构</h2>
<div class="codehilite"><pre><span></span><code>core/
├── __init__.py              # 模块入口，统一导出
├── capabilities.py          # 能力声明系统
├── factory.py               # 工厂模式
├── internal/
│   └── __init__.py          # 内部实现（预留）
├── modes/
│   └── __init__.py          # 推理模式（预留）
├── schemas/
│   ├── __init__.py          # Schema 导出
│   ├── common.py            # 公共类型定义
│   ├── streaming.py         # Streaming 请求/响应
│   └── duplex.py            # Duplex 请求/响应
└── processors/
    ├── __init__.py           # 处理器导出
    ├── base.py               # 基类与 Mixin
    └── unified.py            # 统一处理器实现
</code></pre></div>

<hr />
<h2 id="schemas-pydantic">schemas/ — Pydantic 数据模型</h2>
<h3 id="commonpy">common.py — 公共类型</h3>
<h4 id="_2">枚举</h4>
<table>
<thead>
<tr>
<th>枚举</th>
<th>值</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>Role</code></td>
<td><code>system</code>, <code>user</code>, <code>assistant</code></td>
<td>消息角色</td>
</tr>
<tr>
<td><code>TTSMode</code></td>
<td><code>default</code>, <code>audio_assistant</code>, <code>omni</code>, <code>audio_roleplay</code>, <code>voice_cloning</code></td>
<td>TTS 模式</td>
</tr>
<tr>
<td><code>ContentType</code></td>
<td><code>text</code>, <code>image</code>, <code>audio</code>, <code>video</code></td>
<td>内容类型</td>
</tr>
</tbody>
</table>
<h4 id="_3">内容模型</h4>
<table>
<thead>
<tr>
<th>模型</th>
<th>关键字段</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>TextContent</code></td>
<td><code>type="text"</code>, <code>text: str</code></td>
<td>文本内容</td>
</tr>
<tr>
<td><code>ImageContent</code></td>
<td><code>type="image"</code>, <code>data: str</code></td>
<td>图像内容（Base64）</td>
</tr>
<tr>
<td><code>AudioContent</code></td>
<td><code>type="audio"</code>, <code>data: str</code>, <code>sample_rate: int = 16000</code></td>
<td>音频内容（Base64 PCM float32）</td>
</tr>
<tr>
<td><code>VideoContent</code></td>
<td><code>type="video"</code>, <code>data: str</code>, <code>stack_frames: int = 1</code></td>
<td>视频内容（Base64 视频文件，自动提取帧和音频）</td>
</tr>
</tbody>
</table>
<p>类型别名：<code>ContentItem = Union[TextContent, ImageContent, AudioContent, VideoContent]</code></p>
<h4 id="message">Message 模型</h4>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">Message</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">role</span><span class="p">:</span> <span class="n">Role</span>
    <span class="n">content</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">ContentItem</span><span class="p">]]</span>
</code></pre></div>

<p><code>content</code> 支持纯文本字符串或多模态内容列表。</p>
<h4 id="_4">配置模型</h4>
<table>
<thead>
<tr>
<th>模型</th>
<th>关键字段</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>TTSSamplingParams</code></td>
<td><code>top_p=0.85</code>, <code>temperature=0.8</code>, <code>repetition_penalty=1.05</code></td>
<td>TTS 采样参数</td>
</tr>
<tr>
<td><code>TTSConfig</code></td>
<td><code>enabled</code>, <code>mode</code>, <code>ref_audio_path</code>, <code>ref_audio_data</code>, <code>language</code></td>
<td>TTS 配置</td>
</tr>
<tr>
<td><code>ImageConfig</code></td>
<td><code>max_slice_nums</code>, <code>use_image_id</code></td>
<td>图像处理配置</td>
</tr>
<tr>
<td><code>GenerationConfig</code></td>
<td><code>max_new_tokens=512</code>, <code>temperature=0.7</code>, <code>top_p=0.8</code></td>
<td>生成配置</td>
</tr>
</tbody>
</table>
<h3 id="streamingpy-streaming-schema">streaming.py — Streaming Schema</h3>
<p>流式生成使用的数据结构（<code>StreamingChunk</code> 等），被 ChatView 的 <code>streaming_generate()</code> 复用。</p>
<h3 id="duplexpy-duplex-schema">duplex.py — Duplex 模式 Schema</h3>
<h4 id="duplexconfig">DuplexConfig</h4>
<table>
<thead>
<tr>
<th>字段</th>
<th>默认值</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>generate_audio</code></td>
<td><code>True</code></td>
<td>生成音频</td>
</tr>
<tr>
<td><code>ls_mode</code></td>
<td><code>"explicit"</code></td>
<td>Listen/Speak 模式</td>
</tr>
<tr>
<td><code>force_listen_count</code></td>
<td><code>3</code></td>
<td>启动保护期（前 N 步强制聆听）</td>
</tr>
<tr>
<td><code>max_new_speak_tokens_per_chunk</code></td>
<td><code>20</code></td>
<td>每 chunk 最大说话 token 数</td>
</tr>
<tr>
<td><code>temperature</code></td>
<td><code>0.7</code></td>
<td>生成温度</td>
</tr>
<tr>
<td><code>top_k</code></td>
<td><code>20</code></td>
<td>Top-K 采样</td>
</tr>
<tr>
<td><code>top_p</code></td>
<td><code>0.8</code></td>
<td>Top-P 采样</td>
</tr>
<tr>
<td><code>listen_prob_scale</code></td>
<td><code>1.0</code></td>
<td>聆听概率缩放</td>
</tr>
<tr>
<td><code>chunk_ms</code></td>
<td><code>1000</code></td>
<td>音频 chunk 时长（毫秒）</td>
</tr>
<tr>
<td><code>sample_rate</code></td>
<td><code>16000</code></td>
<td>采样率</td>
</tr>
</tbody>
</table>
<h4 id="duplexpreparerequest">DuplexPrepareRequest</h4>
<p>初始化双工会话：<code>prefix_system_prompt</code>, <code>suffix_system_prompt</code>, <code>ref_audio_path</code>, <code>prompt_wav_path</code>。</p>
<h4 id="duplexprefillrequest">DuplexPrefillRequest</h4>
<p>每步预填充：<code>audio_waveform</code>（Base64）, <code>audio_path</code>, <code>frame_list</code>（视频帧列表）, <code>max_slice_nums</code>。</p>
<h4 id="duplexgenerateresult">DuplexGenerateResult</h4>
<p>单步生成结果：</p>
<table>
<thead>
<tr>
<th>字段</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>is_listen</code></td>
<td>是否处于聆听状态</td>
</tr>
<tr>
<td><code>text</code></td>
<td>生成的文本</td>
</tr>
<tr>
<td><code>audio_data</code></td>
<td>Base64 音频（24kHz）</td>
</tr>
<tr>
<td><code>end_of_turn</code></td>
<td>是否 turn 结束</td>
</tr>
<tr>
<td><code>current_time</code></td>
<td>当前时间戳</td>
</tr>
<tr>
<td><code>cost_llm_ms</code></td>
<td>LLM 推理耗时</td>
</tr>
<tr>
<td><code>cost_tts_ms</code></td>
<td>TTS 耗时</td>
</tr>
<tr>
<td><code>cost_all_ms</code></td>
<td>总耗时</td>
</tr>
<tr>
<td><code>n_tokens</code></td>
<td>生成的 LLM token 数</td>
</tr>
<tr>
<td><code>n_tts_tokens</code></td>
<td>生成的 TTS token 数</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="processors">processors/ — 推理处理器</h2>
<h3 id="basepy">base.py — 基类</h3>
<h4 id="baseprocessor">BaseProcessor（抽象基类）</h4>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">BaseProcessor</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">device</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;cuda&quot;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="nd">@abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">mode</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ProcessorMode</span><span class="p">:</span> <span class="o">...</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">capabilities</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ProcessorCapabilities</span><span class="p">:</span> <span class="o">...</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_load_model</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span> <span class="o">...</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_release_resources</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span> <span class="o">...</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">is_ready</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span> <span class="o">...</span>
</code></pre></div>

<h4 id="minicpmoprocessormixin">MiniCPMOProcessorMixin</h4>
<p>为处理器提供共用功能的 Mixin：</p>
<table>
<thead>
<tr>
<th>方法</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>_load_ref_audio(path, cache)</code></td>
<td>加载参考音频（支持缓存）</td>
</tr>
<tr>
<td><code>_convert_content_to_model_format(content)</code></td>
<td>将 Schema 内容转换为模型格式</td>
</tr>
<tr>
<td><code>_convert_messages_to_model_format(messages, tts_config)</code></td>
<td>将消息列表转换为模型格式</td>
</tr>
<tr>
<td><code>_resolve_ref_audio(tts_config)</code></td>
<td>解析参考音频（路径或 Base64）</td>
</tr>
<tr>
<td><code>_init_tts_mode(streaming)</code></td>
<td>初始化 TTS 模式</td>
</tr>
</tbody>
</table>
<h3 id="unifiedpy">unified.py — 统一处理器</h3>
<h4 id="unifiedprocessor">UnifiedProcessor</h4>
<p>统一处理器，一次加载模型，支持 Streaming / Duplex 两种模式毫秒级热切换。</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">UnifiedProcessor</span><span class="p">(</span><span class="n">BaseProcessor</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">model_path</span><span class="p">,</span> <span class="n">pt_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="s2">&quot;cuda&quot;</span><span class="p">,</span>
        <span class="n">ref_audio_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">duplex_config</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">preload_both_tts</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="nb">compile</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">attn_implementation</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span>
    <span class="p">)</span>
</code></pre></div>

<table>
<thead>
<tr>
<th>方法/属性</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>_load_model()</code></td>
<td>加载模型和 TTS</td>
</tr>
<tr>
<td><code>_release_resources()</code></td>
<td>释放所有资源</td>
</tr>
<tr>
<td><code>set_streaming_mode()</code></td>
<td>切换到 Streaming 模式，返回 <code>StreamingView</code></td>
</tr>
<tr>
<td><code>set_duplex_mode()</code></td>
<td>切换到 Duplex 模式，返回 <code>DuplexView</code></td>
</tr>
<tr>
<td><code>streaming</code></td>
<td>StreamingView 属性</td>
</tr>
<tr>
<td><code>duplex</code></td>
<td>DuplexView 属性</td>
</tr>
<tr>
<td><code>kv_cache_length</code></td>
<td>当前 KV Cache 长度</td>
</tr>
</tbody>
</table>
<h4 id="chatview">ChatView</h4>
<p>ChatView 提供 Turn-based Chat 的专用 API，支持流式和非流式两种生成模式。</p>
<table>
<thead>
<tr>
<th>方法/属性</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>prefill(session_id, msgs, ...)</code></td>
<td>一次性 prefill 所有消息到 KV Cache</td>
</tr>
<tr>
<td><code>generate(session_id, ...)</code></td>
<td>非流式生成（HF generate + TTS）</td>
</tr>
<tr>
<td><code>streaming_generate(session_id, ...)</code></td>
<td>流式生成，返回 <code>Generator[StreamingChunk]</code></td>
</tr>
<tr>
<td><code>kv_cache_length</code></td>
<td>当前 KV Cache 长度</td>
</tr>
<tr>
<td><code>chat(request)</code></td>
<td>兼容旧接口（一体式 prefill + generate）</td>
</tr>
</tbody>
</table>
<h4 id="duplexview">DuplexView</h4>
<table>
<thead>
<tr>
<th>方法</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>prepare(system_prompt_text, ref_audio_path, prompt_wav_path)</code></td>
<td>准备双工会话</td>
</tr>
<tr>
<td><code>prefill(audio_waveform, audio_path, frame_list, max_slice_nums)</code></td>
<td>预填充音频/视频</td>
</tr>
<tr>
<td><code>generate(force_listen)</code></td>
<td>生成一步，返回 <code>DuplexGenerateResult</code></td>
</tr>
<tr>
<td><code>finalize()</code></td>
<td>结束当前 turn</td>
</tr>
<tr>
<td><code>set_break()</code> / <code>clear_break()</code></td>
<td>设置/清除中断标志</td>
</tr>
<tr>
<td><code>stop()</code></td>
<td>停止会话</td>
</tr>
<tr>
<td><code>is_break_set()</code> / <code>is_stopped()</code></td>
<td>查询状态</td>
</tr>
<tr>
<td><code>cleanup()</code></td>
<td>清理资源，释放 GPU 显存</td>
</tr>
<tr>
<td><code>offline_inference(task_input)</code></td>
<td>离线推理</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="capabilitiespy">capabilities.py — 能力声明系统</h2>
<h3 id="processormode">ProcessorMode 枚举</h3>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">ProcessorMode</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
    <span class="n">STREAMING</span> <span class="o">=</span> <span class="s2">&quot;streaming&quot;</span>
    <span class="n">DUPLEX</span> <span class="o">=</span> <span class="s2">&quot;duplex&quot;</span>
</code></pre></div>

<h3 id="processorcapabilities">ProcessorCapabilities 数据类</h3>
<div class="codehilite"><pre><span></span><code><span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">ProcessorCapabilities</span><span class="p">:</span>
    <span class="n">mode</span><span class="p">:</span> <span class="n">ProcessorMode</span>
    <span class="c1"># 输入能力</span>
    <span class="n">supports_text</span><span class="p">:</span> <span class="nb">bool</span>
    <span class="n">supports_image</span><span class="p">:</span> <span class="nb">bool</span>
    <span class="n">supports_audio</span><span class="p">:</span> <span class="nb">bool</span>
    <span class="n">supports_video</span><span class="p">:</span> <span class="nb">bool</span>
    <span class="c1"># 输出能力</span>
    <span class="n">supports_text_output</span><span class="p">:</span> <span class="nb">bool</span>
    <span class="n">supports_audio_output</span><span class="p">:</span> <span class="nb">bool</span>
    <span class="n">supports_streaming_output</span><span class="p">:</span> <span class="nb">bool</span>
    <span class="c1"># 交互能力</span>
    <span class="n">supports_multi_turn</span><span class="p">:</span> <span class="nb">bool</span>
    <span class="n">supports_interrupt</span><span class="p">:</span> <span class="nb">bool</span>
    <span class="n">supports_rollback</span><span class="p">:</span> <span class="nb">bool</span>
    <span class="c1"># 资源需求</span>
    <span class="n">requires_exclusive_worker</span><span class="p">:</span> <span class="nb">bool</span>
    <span class="n">supports_kv_cache_reuse</span><span class="p">:</span> <span class="nb">bool</span>
</code></pre></div>

<h3 id="_5">预定义能力常量</h3>
<table>
<thead>
<tr>
<th>能力</th>
<th>Streaming</th>
<th>Duplex</th>
</tr>
</thead>
<tbody>
<tr>
<td>流式输出</td>
<td>支持</td>
<td>支持</td>
</tr>
<tr>
<td>打断支持</td>
<td>--</td>
<td>支持</td>
</tr>
<tr>
<td>回溯支持</td>
<td>支持</td>
<td>--</td>
</tr>
<tr>
<td>KV Cache 复用</td>
<td>支持</td>
<td>支持</td>
</tr>
<tr>
<td>独占 Worker</td>
<td>--</td>
<td>需要</td>
</tr>
<tr>
<td>多轮对话</td>
<td>支持</td>
<td>支持</td>
</tr>
</tbody>
</table>
<h3 id="_6">辅助函数</h3>
<ul>
<li><code>get_capabilities(mode)</code> — 根据模式获取能力声明</li>
<li><code>supports_feature(mode, feature)</code> — 检查某模式是否支持特定特性</li>
</ul>
<hr />
<h2 id="factorypy">factory.py — 工厂模式</h2>
<h3 id="processorfactory">ProcessorFactory</h3>
<table>
<thead>
<tr>
<th>方法</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>get_processor(...)</code></td>
<td>获取或创建 UnifiedProcessor（带缓存）</td>
</tr>
<tr>
<td><code>create(mode, ...)</code></td>
<td>创建指定模式的 View</td>
</tr>
<tr>
<td><code>from_config(config)</code></td>
<td>从配置字典创建 View</td>
</tr>
</tbody>
</table>
<p>便捷函数：<code>create_processor(mode, ...)</code> — 快速创建指定模式的 View。</p></article>
  <footer><p>MiniCPM-o 4.5 PyTorch Simple Demo &mdash; 由 build_docs.py 自动生成</p></footer>
</main>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/python.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/bash.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/json.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/javascript.min.js"></script>
<script type="module">
import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.esm.min.mjs';
mermaid.initialize({startOnLoad:true,theme:'default',securityLevel:'loose'});
</script>
<script>
hljs.highlightAll();
function toggleSidebar(){document.getElementById('sidebar').classList.toggle('open');document.getElementById('content').classList.toggle('shifted');}
document.querySelectorAll('.nav-group-header').forEach(function(h){h.addEventListener('click',function(){this.parentElement.classList.toggle('collapsed');});});
document.addEventListener('click',function(e){var s=document.getElementById('sidebar'),t=document.querySelector('.sidebar-toggle');if(window.innerWidth<=768&&s.classList.contains('open')&&!s.contains(e.target)&&!t.contains(e.target)){s.classList.remove('open');document.getElementById('content').classList.remove('shifted');}});
</script>
</body>
</html>
