<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Chat 模式 - MiniCPM-o 4.5 文档</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">
<style>
* { margin:0; padding:0; box-sizing:border-box; }
:root {
  --sidebar-w: 260px;
  --bg: #fff; --bg-side: #f8f9fa; --bg-code: #f6f8fa;
  --c1: #24292f; --c2: #57606a;
  --border: #d0d7de; --accent: #0969da; --nav-active: #ddf4ff;
}
body { font-family: -apple-system,BlinkMacSystemFont,"Segoe UI","Noto Sans",Helvetica,Arial,sans-serif; color:var(--c1); line-height:1.6; background:var(--bg); }
.sidebar-toggle { position:fixed; top:12px; left:12px; z-index:1001; background:var(--bg-side); border:1px solid var(--border); border-radius:6px; padding:6px 10px; font-size:18px; cursor:pointer; display:none; }
.sidebar { position:fixed; top:0; left:0; width:var(--sidebar-w); height:100vh; overflow-y:auto; background:var(--bg-side); border-right:1px solid var(--border); padding:20px 0; z-index:1000; transition:transform .3s; }
.sidebar-header { padding:0 20px 16px; border-bottom:1px solid var(--border); margin-bottom:8px; }
.sidebar-header h2 { font-size:16px; font-weight:600; }
.sidebar-subtitle { font-size:12px; color:var(--c2); }
.lang-switch { display:inline-block; margin-top:6px; font-size:12px; color:var(--accent); text-decoration:none; padding:2px 8px; border:1px solid var(--border); border-radius:4px; transition:background .15s; }
.lang-switch:hover { background:var(--nav-active); text-decoration:none; }

.nav-list { list-style:none; padding:0 8px; }
.nav-list > li > a { display:block; padding:7px 12px; color:var(--c2); text-decoration:none; font-size:14px; border-radius:6px; transition:background .15s,color .15s; }
.nav-list > li > a:hover { background:#e8e8e8; color:var(--c1); }
.nav-list > li > a.active { background:var(--nav-active); color:var(--accent); font-weight:600; }

.nav-group { margin-top:4px; }
.nav-group-header { display:flex; align-items:center; gap:6px; padding:8px 12px; color:var(--c1); font-size:12px; font-weight:700; text-transform:uppercase; letter-spacing:.04em; cursor:pointer; border-radius:6px; user-select:none; transition:background .15s; }
.nav-group-header:hover { background:#eaeef2; }
.nav-group-header::before { content:""; display:inline-block; width:0; height:0; border-left:5px solid var(--c2); border-top:3.5px solid transparent; border-bottom:3.5px solid transparent; transition:transform .2s; transform:rotate(90deg); flex-shrink:0; }
.nav-group.collapsed .nav-group-header::before { transform:rotate(0); }
.nav-group-children { list-style:none; margin:0 0 4px 19px; padding:3px 0 3px 13px; border-left:2px solid #e1e4e8; overflow:hidden; max-height:500px; transition:max-height .25s ease,opacity .2s ease,padding .2s ease; opacity:1; }
.nav-group.collapsed .nav-group-children { max-height:0; opacity:0; padding:0 0 0 13px; }
.nav-group-children li a { display:block; padding:4px 10px; font-size:13px; color:var(--c2); text-decoration:none; border-radius:4px; transition:background .15s,color .15s; }
.nav-group-children li a:hover { background:#e8e8e8; color:var(--c1); }
.nav-group-children li a.active { background:var(--nav-active); color:var(--accent); font-weight:600; }

.content { margin-left:var(--sidebar-w); max-width:900px; padding:40px 48px; }
article h1 { font-size:28px; font-weight:600; padding-bottom:10px; border-bottom:1px solid var(--border); margin-bottom:20px; }
article h2 { font-size:22px; font-weight:600; margin-top:32px; margin-bottom:12px; padding-bottom:6px; border-bottom:1px solid #eaecef; }
article h3 { font-size:18px; font-weight:600; margin-top:24px; margin-bottom:10px; }
article h4 { font-size:15px; font-weight:600; margin-top:20px; margin-bottom:8px; }
article p { margin-bottom:14px; }
article ul,article ol { margin-bottom:14px; padding-left:24px; }
article li { margin-bottom:4px; }
article a { color:var(--accent); text-decoration:none; }
article a:hover { text-decoration:underline; }
article code { background:var(--bg-code); padding:2px 6px; border-radius:4px; font-size:13px; font-family:"SFMono-Regular",Consolas,"Liberation Mono",Menlo,monospace; }
article pre { background:var(--bg-code); border:1px solid var(--border); border-radius:6px; padding:16px; overflow-x:auto; margin-bottom:16px; line-height:1.5; }
article pre code { background:none; padding:0; font-size:13px; }
article table { width:100%; border-collapse:collapse; margin-bottom:16px; font-size:14px; }
article th,article td { border:1px solid var(--border); padding:8px 12px; text-align:left; }
article th { background:var(--bg-code); font-weight:600; }
article tr:nth-child(even) { background:#f8f9fa; }
article hr { border:none; border-top:1px solid var(--border); margin:28px 0; }
article blockquote { border-left:4px solid var(--accent); padding:8px 16px; margin:0 0 16px; color:var(--c2); background:#f8f9fa; border-radius:0 6px 6px 0; }
article .mermaid { text-align:center; margin:20px 0; }
footer { margin-top:60px; padding-top:16px; border-top:1px solid var(--border); color:var(--c2); font-size:13px; }
@media(max-width:768px) {
  .sidebar { transform:translateX(-100%); }
  .sidebar.open { transform:translateX(0); box-shadow:2px 0 8px rgba(0,0,0,.15); }
  .sidebar-toggle { display:block; }
  .content { margin-left:0; padding:50px 20px 40px; }
  .content.shifted { margin-left:var(--sidebar-w); }
}
</style>
</head>
<body>
<button class="sidebar-toggle" onclick="toggleSidebar()" aria-label="Toggle sidebar">&#9776;</button>
<nav class="sidebar" id="sidebar">
  <div class="sidebar-header">
    <h2>MiniCPM-o 4.5</h2>
    <span class="sidebar-subtitle">项目文档</span>
    <a href="../../en/architecture/streaming.html" class="lang-switch">English</a>
  </div>
  <ul class="nav-list">
    <li><a href="../index.html">项目概述</a></li>
    <li class="nav-group">
      <span class="nav-group-header">系统架构</span>
      <ul class="nav-group-children">
        <li><a href="../architecture/index.html">架构概述</a></li>
        <li><a href="../architecture/streaming.html" class="active">Chat 模式</a></li>
        <li><a href="../architecture/duplex.html">Duplex 模式</a></li>
        <li><a href="../architecture/internals.html">内部机制</a></li>
      </ul>
    </li>
    <li><a href="../gateway.html">Gateway 模块</a></li>
    <li><a href="../worker.html">Worker 模块</a></li>
    <li><a href="../schema.html">Schema</a></li>
    <li><a href="../model.html">模型模块</a></li>
    <li><a href="../compile.html">torch.compile</a></li>
    <li class="nav-group">
      <span class="nav-group-header">前端模块</span>
      <ul class="nav-group-children">
        <li><a href="../frontend/index.html">前端概述</a></li>
        <li><a href="../frontend/pages.html">页面与路由</a></li>
        <li><a href="../frontend/audio.html">音频处理</a></li>
        <li><a href="../frontend/duplex-session.html">双工会话</a></li>
        <li><a href="../frontend/components.html">UI 组件</a></li>
      </ul>
    </li>
    <li><a href="../api.html">API 参考</a></li>
    <li><a href="../deployment.html">配置与部署</a></li>
  </ul>
</nav>
<main class="content" id="content">
  <article><h1 id="chat">Chat 模式详解</h1>
<p>Turn-based Chat 页面的核心推理模式。通过 <code>/ws/chat</code> WebSocket 接口，支持<strong>流式</strong>和<strong>非流式</strong>两种响应方式。</p>
<h2 id="_1">一句话理解</h2>
<blockquote>
<p>先把所有历史消息一次性"喂"给模型（<strong>Prefill</strong>），再让模型基于已有上下文生成回复（<strong>Generate</strong>）。</p>
</blockquote>
<h2 id="_2">整体流程</h2>
<h3 id="_3">简化视角</h3>
<p>前端和模型之间只有两步交互：</p>
<pre class="mermaid">
sequenceDiagram
    participant FE as 前端
    participant MD as Model

    FE->>MD: 1. Prefill：所有消息
    MD-->>FE: 2. Generate：回复（文本 + 可选音频）
</pre>

<h3 id="_4">详细视角</h3>
<p>加入中间层（Gateway 透传代理 + Worker 调度）后的完整流程：</p>
<pre class="mermaid">
sequenceDiagram
    participant FE as 前端
    participant GW as Gateway
    participant WK as Worker
    participant MD as Model

    FE->>GW: WebSocket /ws/chat
    GW->>WK: WebSocket 透传
    FE->>WK: {messages, streaming, tts, ...}

    WK->>MD: Prefill（一次性填充所有消息）
    MD-->>WK: KV Cache 就绪
    WK-->>FE: prefill_done

    alt 流式响应
        loop 逐 chunk 生成
            MD-->>WK: 文本片段 + 音频片段
            WK-->>FE: {type: "chunk", text_delta, audio_data}
        end
    else 非流式响应
        MD-->>WK: 完整文本 + 完整音频
    end

    WK-->>FE: {type: "done", text, generated_tokens}
</pre>

<h2 id="prefill">Prefill 阶段</h2>
<p>Prefill 将对话历史（system prompt + 多轮 user/assistant 消息）一次性填充到模型的 <strong>KV Cache</strong> 中。</p>
<p>关键行为：
- 使用 <code>apply_chat_template</code> 构建 prompt，但 <strong>不加 generation prompt</strong>（<code>add_generation_prompt=False</code>）
- generation prompt（<code>&lt;|im_start|&gt;assistant\n</code>）在 Generate 阶段才注入
- 支持多模态输入：文本、图片、音频、视频</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># 伪代码</span>
<span class="n">prompt</span> <span class="o">=</span> <span class="n">tokenizer</span><span class="o">.</span><span class="n">apply_chat_template</span><span class="p">(</span><span class="n">msgs</span><span class="p">,</span> <span class="n">add_generation_prompt</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">inputs</span> <span class="o">=</span> <span class="n">processor</span><span class="p">(</span><span class="n">prompt</span><span class="p">,</span> <span class="n">images</span><span class="p">,</span> <span class="n">audios</span><span class="p">)</span>
<span class="n">inputs_embeds</span> <span class="o">=</span> <span class="n">get_vllm_embedding</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span>   <span class="c1"># 视觉编码</span>
<span class="n">inputs_embeds</span> <span class="o">=</span> <span class="n">get_omni_embedding</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span>   <span class="c1"># 音频编码</span>

<span class="c1"># 填充 KV Cache</span>
<span class="n">outputs</span> <span class="o">=</span> <span class="n">llm</span><span class="p">(</span><span class="n">inputs_embeds</span><span class="o">=</span><span class="n">inputs_embeds</span><span class="p">,</span> <span class="n">use_cache</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">kv_cache</span> <span class="o">=</span> <span class="n">outputs</span><span class="o">.</span><span class="n">past_key_values</span>
</code></pre></div>

<h2 id="generate">Generate 阶段</h2>
<p>Generate 基于已填充的 KV Cache 生成回复。首先注入 bos string，然后分流：</p>
<h3 id="bos-string">注入 bos string</h3>
<div class="codehilite"><pre><span></span><code><span class="err">&lt;</span>|im_end|&gt;\n<span class="err">&lt;</span>|im_start|&gt;assistant\n<span class="nt">&lt;think&gt;</span>\n\n<span class="nt">&lt;/think&gt;</span>\n\n<span class="err">&lt;</span>|tts_bos|&gt;
</code></pre></div>

<p>这与模型在 <code>chat()</code> 和 <code>streaming_generate()</code> 中的行为一致。</p>
<h3 id="_5">非流式生成</h3>
<p>使用 HuggingFace 标准的 <code>llm.generate()</code> API：</p>
<ol>
<li>bos string → embedding → KV Cache 前向</li>
<li><code>llm.generate(past_key_values=kv_cache, ...)</code> 生成完整序列</li>
<li>解码文本</li>
<li>可选：调用 <code>_generate_speech_non_streaming()</code> 生成 TTS 音频</li>
</ol>
<p>适合：短回复、不需要实时反馈的场景。</p>
<h3 id="_6">流式生成</h3>
<p>使用模型内部的 <code>streaming_generate()</code> 方法：</p>
<ol>
<li>bos string 自动注入</li>
<li>每 10 个 token 为一组生成（<code>ChunkPrefillChunkGenerate</code>）</li>
<li>每组 token 送入 TTS 生成音频 chunk</li>
<li>逐块 yield (waveform_chunk, text_delta)</li>
</ol>
<p>适合：长回复、需要实时逐字显示的场景。</p>
<h2 id="websocket">WebSocket 协议</h2>
<h3 id="_7">端点</h3>
<div class="codehilite"><pre><span></span><code>wss://host/ws/chat
</code></pre></div>

<h3 id="_8">请求格式</h3>
<p>连接后发送一次 JSON：</p>
<div class="codehilite"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;messages&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="p">{</span><span class="nt">&quot;role&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;system&quot;</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;content&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[{</span><span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;text&quot;</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;text&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;...&quot;</span><span class="p">}]},</span>
<span class="w">    </span><span class="p">{</span><span class="nt">&quot;role&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;user&quot;</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;content&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;你好&quot;</span><span class="p">}</span>
<span class="w">  </span><span class="p">],</span>
<span class="w">  </span><span class="nt">&quot;streaming&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;generation&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="nt">&quot;max_new_tokens&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">256</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;length_penalty&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">1.1</span><span class="p">},</span>
<span class="w">  </span><span class="nt">&quot;tts&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="nt">&quot;enabled&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;ref_audio_data&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;&lt;base64&gt;&quot;</span><span class="p">},</span>
<span class="w">  </span><span class="nt">&quot;image&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="nt">&quot;max_slice_nums&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="p">},</span>
<span class="w">  </span><span class="nt">&quot;omni_mode&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span>
<span class="p">}</span>
</code></pre></div>

<table>
<thead>
<tr>
<th>字段</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>messages</code></td>
<td>完整消息历史（含 system prompt）</td>
</tr>
<tr>
<td><code>streaming</code></td>
<td><code>true</code> 流式 / <code>false</code> 非流式</td>
</tr>
<tr>
<td><code>generation</code></td>
<td>生成参数（max_new_tokens、length_penalty 等）</td>
</tr>
<tr>
<td><code>tts</code></td>
<td>Voice Response 配置（enabled、ref_audio_data）</td>
</tr>
<tr>
<td><code>omni_mode</code></td>
<td>视频输入时为 <code>true</code></td>
</tr>
</tbody>
</table>
<h3 id="_9">响应消息</h3>
<table>
<thead>
<tr>
<th>类型</th>
<th>字段</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>prefill_done</code></td>
<td><code>input_tokens</code></td>
<td>Prefill 完成，返回输入 token 数</td>
</tr>
<tr>
<td><code>chunk</code></td>
<td><code>text_delta</code>, <code>audio_data</code></td>
<td>流式生成的一个 chunk（仅 streaming=true）</td>
</tr>
<tr>
<td><code>done</code></td>
<td><code>text</code>, <code>generated_tokens</code>, <code>input_tokens</code>, <code>audio_data</code></td>
<td>生成完成</td>
</tr>
<tr>
<td><code>error</code></td>
<td><code>error</code></td>
<td>错误信息</td>
</tr>
</tbody>
</table>
<h2 id="_10">调用链路</h2>
<div class="codehilite"><pre><span></span><code>前端 turnbased.html
  └─ WebSocket /ws/chat
      └─ Gateway（WS 透传代理）
          └─ Worker /ws/chat
              ├─ chat_prefill()
              │   └─ ChatView.prefill()
              │       └─ model.non_streaming_prefill()
              ├─ TTS init
              │   └─ model.init_token2wav_cache()
              └─ 生成
                  ├─ 流式: chat_streaming_generate()
                  │   └─ ChatView.streaming_generate()
                  │       └─ model.streaming_generate()
                  └─ 非流式: chat_non_streaming_generate()
                      └─ ChatView.generate()
                          └─ model.non_streaming_generate()
</code></pre></div>

<h2 id="voice-response">Voice Response</h2>
<p>前端提供 "Voice Response" 开关：</p>
<table>
<thead>
<tr>
<th>状态</th>
<th>行为</th>
</tr>
</thead>
<tbody>
<tr>
<td>开启</td>
<td>生成语音回复 + 文本；自动抑制特殊字符（Markdown <code>*</code>、<code>#</code>、代码符号等），确保文本适合语音播报</td>
</tr>
<tr>
<td>关闭</td>
<td>仅生成文本；不抑制任何字符，可自由输出 Markdown、代码等</td>
</tr>
</tbody>
</table>
<p>技术实现：<code>ChunkPrefillChunkGenerate.chunk_generate()</code> 的 <code>suppress_forbidden_tokens</code> 参数由 <code>generate_audio</code> 控制。</p>
<h2 id="_11">视频输入</h2>
<p>Chat 模式支持视频输入（<code>VideoContent</code>）：</p>
<ol>
<li>前端上传视频文件 → Base64 编码</li>
<li>Processor 解码为临时文件 → <code>get_video_frame_audio_segments()</code> 提取帧和音频</li>
<li>帧和音频按交错顺序（frame, audio, [stacked_frame], ...）送入模型</li>
<li>请求中自动设置 <code>omni_mode: true</code>，<code>max_slice_nums: 1</code></li>
</ol></article>
  <footer><p>MiniCPM-o 4.5 PyTorch Simple Demo &mdash; 由 build_docs.py 自动生成</p></footer>
</main>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/python.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/bash.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/json.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/javascript.min.js"></script>
<script type="module">
import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.esm.min.mjs';
mermaid.initialize({startOnLoad:true,theme:'default',securityLevel:'loose'});
</script>
<script>
hljs.highlightAll();
function toggleSidebar(){document.getElementById('sidebar').classList.toggle('open');document.getElementById('content').classList.toggle('shifted');}
document.querySelectorAll('.nav-group-header').forEach(function(h){h.addEventListener('click',function(){this.parentElement.classList.toggle('collapsed');});});
document.addEventListener('click',function(e){var s=document.getElementById('sidebar'),t=document.querySelector('.sidebar-toggle');if(window.innerWidth<=768&&s.classList.contains('open')&&!s.contains(e.target)&&!t.contains(e.target)){s.classList.remove('open');document.getElementById('content').classList.remove('shifted');}});
</script>
</body>
</html>
