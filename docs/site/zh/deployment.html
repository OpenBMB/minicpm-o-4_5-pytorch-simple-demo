<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>配置与部署 - MiniCPM-o 4.5 文档</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">
<style>
* { margin:0; padding:0; box-sizing:border-box; }
:root {
  --sidebar-w: 260px;
  --bg: #fff; --bg-side: #f8f9fa; --bg-code: #f6f8fa;
  --c1: #24292f; --c2: #57606a;
  --border: #d0d7de; --accent: #0969da; --nav-active: #ddf4ff;
}
body { font-family: -apple-system,BlinkMacSystemFont,"Segoe UI","Noto Sans",Helvetica,Arial,sans-serif; color:var(--c1); line-height:1.6; background:var(--bg); }
.sidebar-toggle { position:fixed; top:12px; left:12px; z-index:1001; background:var(--bg-side); border:1px solid var(--border); border-radius:6px; padding:6px 10px; font-size:18px; cursor:pointer; display:none; }
.sidebar { position:fixed; top:0; left:0; width:var(--sidebar-w); height:100vh; overflow-y:auto; background:var(--bg-side); border-right:1px solid var(--border); padding:20px 0; z-index:1000; transition:transform .3s; }
.sidebar-header { padding:0 20px 16px; border-bottom:1px solid var(--border); margin-bottom:8px; }
.sidebar-header h2 { font-size:16px; font-weight:600; }
.sidebar-subtitle { font-size:12px; color:var(--c2); }
.lang-switch { display:inline-block; margin-top:6px; font-size:12px; color:var(--accent); text-decoration:none; padding:2px 8px; border:1px solid var(--border); border-radius:4px; transition:background .15s; }
.lang-switch:hover { background:var(--nav-active); text-decoration:none; }

.nav-list { list-style:none; padding:0 8px; }
.nav-list > li > a { display:block; padding:7px 12px; color:var(--c2); text-decoration:none; font-size:14px; border-radius:6px; transition:background .15s,color .15s; }
.nav-list > li > a:hover { background:#e8e8e8; color:var(--c1); }
.nav-list > li > a.active { background:var(--nav-active); color:var(--accent); font-weight:600; }

.nav-group { margin-top:4px; }
.nav-group-header { display:flex; align-items:center; gap:6px; padding:8px 12px; color:var(--c1); font-size:12px; font-weight:700; text-transform:uppercase; letter-spacing:.04em; cursor:pointer; border-radius:6px; user-select:none; transition:background .15s; }
.nav-group-header:hover { background:#eaeef2; }
.nav-group-header::before { content:""; display:inline-block; width:0; height:0; border-left:5px solid var(--c2); border-top:3.5px solid transparent; border-bottom:3.5px solid transparent; transition:transform .2s; transform:rotate(90deg); flex-shrink:0; }
.nav-group.collapsed .nav-group-header::before { transform:rotate(0); }
.nav-group-children { list-style:none; margin:0 0 4px 19px; padding:3px 0 3px 13px; border-left:2px solid #e1e4e8; overflow:hidden; max-height:500px; transition:max-height .25s ease,opacity .2s ease,padding .2s ease; opacity:1; }
.nav-group.collapsed .nav-group-children { max-height:0; opacity:0; padding:0 0 0 13px; }
.nav-group-children li a { display:block; padding:4px 10px; font-size:13px; color:var(--c2); text-decoration:none; border-radius:4px; transition:background .15s,color .15s; }
.nav-group-children li a:hover { background:#e8e8e8; color:var(--c1); }
.nav-group-children li a.active { background:var(--nav-active); color:var(--accent); font-weight:600; }

.content { margin-left:var(--sidebar-w); max-width:900px; padding:40px 48px; }
article h1 { font-size:28px; font-weight:600; padding-bottom:10px; border-bottom:1px solid var(--border); margin-bottom:20px; }
article h2 { font-size:22px; font-weight:600; margin-top:32px; margin-bottom:12px; padding-bottom:6px; border-bottom:1px solid #eaecef; }
article h3 { font-size:18px; font-weight:600; margin-top:24px; margin-bottom:10px; }
article h4 { font-size:15px; font-weight:600; margin-top:20px; margin-bottom:8px; }
article p { margin-bottom:14px; }
article ul,article ol { margin-bottom:14px; padding-left:24px; }
article li { margin-bottom:4px; }
article a { color:var(--accent); text-decoration:none; }
article a:hover { text-decoration:underline; }
article code { background:var(--bg-code); padding:2px 6px; border-radius:4px; font-size:13px; font-family:"SFMono-Regular",Consolas,"Liberation Mono",Menlo,monospace; }
article pre { background:var(--bg-code); border:1px solid var(--border); border-radius:6px; padding:16px; overflow-x:auto; margin-bottom:16px; line-height:1.5; }
article pre code { background:none; padding:0; font-size:13px; }
article table { width:100%; border-collapse:collapse; margin-bottom:16px; font-size:14px; }
article th,article td { border:1px solid var(--border); padding:8px 12px; text-align:left; }
article th { background:var(--bg-code); font-weight:600; }
article tr:nth-child(even) { background:#f8f9fa; }
article hr { border:none; border-top:1px solid var(--border); margin:28px 0; }
article blockquote { border-left:4px solid var(--accent); padding:8px 16px; margin:0 0 16px; color:var(--c2); background:#f8f9fa; border-radius:0 6px 6px 0; }
article .mermaid { text-align:center; margin:20px 0; }
footer { margin-top:60px; padding-top:16px; border-top:1px solid var(--border); color:var(--c2); font-size:13px; }
@media(max-width:768px) {
  .sidebar { transform:translateX(-100%); }
  .sidebar.open { transform:translateX(0); box-shadow:2px 0 8px rgba(0,0,0,.15); }
  .sidebar-toggle { display:block; }
  .content { margin-left:0; padding:50px 20px 40px; }
  .content.shifted { margin-left:var(--sidebar-w); }
}
</style>
</head>
<body>
<button class="sidebar-toggle" onclick="toggleSidebar()" aria-label="Toggle sidebar">&#9776;</button>
<nav class="sidebar" id="sidebar">
  <div class="sidebar-header">
    <h2>MiniCPM-o 4.5</h2>
    <span class="sidebar-subtitle">项目文档</span>
    <a href="../en/deployment.html" class="lang-switch">English</a>
  </div>
  <ul class="nav-list">
    <li><a href="index.html">项目概述</a></li>
    <li class="nav-group">
      <span class="nav-group-header">系统架构</span>
      <ul class="nav-group-children">
        <li><a href="architecture/index.html">架构概述</a></li>
        <li><a href="architecture/chat.html">Chat 模式</a></li>
        <li><a href="architecture/half-duplex.html">Half-Duplex 模式</a></li>
        <li><a href="architecture/duplex.html">Duplex 模式</a></li>
        <li><a href="architecture/internals.html">内部机制</a></li>
      </ul>
    </li>
    <li><a href="gateway.html">Gateway 模块</a></li>
    <li><a href="worker.html">Worker 模块</a></li>
    <li><a href="schema.html">Schema</a></li>
    <li><a href="model.html">模型模块</a></li>
    <li><a href="compile.html">torch.compile</a></li>
    <li class="nav-group">
      <span class="nav-group-header">前端模块</span>
      <ul class="nav-group-children">
        <li><a href="frontend/index.html">前端概述</a></li>
        <li><a href="frontend/pages.html">页面与路由</a></li>
        <li><a href="frontend/audio.html">音频处理</a></li>
        <li><a href="frontend/duplex-session.html">双工会话</a></li>
        <li><a href="frontend/components.html">UI 组件</a></li>
      </ul>
    </li>
    <li><a href="api.html">API 参考</a></li>
    <li><a href="deployment.html" class="active">配置与部署</a></li>
  </ul>
</nav>
<main class="content" id="content">
  <article><h1 id="_1">配置与部署</h1>
<h2 id="_2">系统要求</h2>
<table>
<thead>
<tr>
<th>要求</th>
<th>最低配置</th>
</tr>
</thead>
<tbody>
<tr>
<td>GPU</td>
<td>NVIDIA GPU，显存 &gt; 28GB</td>
</tr>
<tr>
<td>操作系统</td>
<td>Linux</td>
</tr>
<tr>
<td>Python</td>
<td>3.10</td>
</tr>
<tr>
<td>CUDA</td>
<td>与 PyTorch 2.8.0 兼容</td>
</tr>
<tr>
<td>FFmpeg</td>
<td>用于视频帧提取和推理结果可视化</td>
</tr>
</tbody>
</table>
<h3 id="_3">资源消耗参考</h3>
<table>
<thead>
<tr>
<th>资源</th>
<th>Token2Wav（默认）</th>
</tr>
</thead>
<tbody>
<tr>
<td>显存（每 Worker，初始化后）</td>
<td>~21.5 GB</td>
</tr>
<tr>
<td>模型加载时间</td>
<td>~16s</td>
</tr>
<tr>
<td>模式切换延迟</td>
<td>&lt; 0.1ms</td>
</tr>
</tbody>
</table>
<blockquote>
<p>torch.compile 模式首次推理额外 ~60s 编译耗时。</p>
</blockquote>
<hr />
<h2 id="_4">依赖安装</h2>
<h3 id="installsh">使用 install.sh（推荐）</h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># 1. 安装 Python 3.10（推荐 miniconda）</span>
mkdir<span class="w"> </span>-p<span class="w"> </span>./miniconda3_install_tmp
wget<span class="w"> </span>https://repo.anaconda.com/miniconda/Miniconda3-py310_25.11.1-1-Linux-x86_64.sh<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-O<span class="w"> </span>./miniconda3_install_tmp/miniconda.sh
bash<span class="w"> </span>./miniconda3_install_tmp/miniconda.sh<span class="w"> </span>-b<span class="w"> </span>-u<span class="w"> </span>-p<span class="w"> </span>./miniconda3
<span class="nb">source</span><span class="w"> </span>./miniconda3/bin/activate

<span class="c1"># 2. 一键安装</span>
bash<span class="w"> </span>./install.sh
</code></pre></div>

<p><code>install.sh</code> 自动完成以下步骤：
1. 在 <code>.venv/base</code> 创建 Python venv 虚拟环境
2. 安装 PyTorch 2.8.0 + torchaudio
3. 安装 <code>requirements.txt</code> 中的所有依赖
4. 验证安装结果</p>
<h3 id="_5">手动安装</h3>
<div class="codehilite"><pre><span></span><code><span class="nb">source</span><span class="w"> </span>./miniconda3/bin/activate
python<span class="w"> </span>-m<span class="w"> </span>venv<span class="w"> </span>.venv/base
<span class="nb">source</span><span class="w"> </span>.venv/base/bin/activate

pip<span class="w"> </span>install<span class="w"> </span><span class="s2">&quot;torch==2.8.0&quot;</span><span class="w"> </span><span class="s2">&quot;torchaudio==2.8.0&quot;</span>
pip<span class="w"> </span>install<span class="w"> </span>-r<span class="w"> </span>requirements.txt
</code></pre></div>

<h3 id="python">Python 依赖清单</h3>
<table>
<thead>
<tr>
<th>类别</th>
<th>包</th>
<th>版本</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>核心 ML</strong></td>
<td>transformers</td>
<td>4.51.0</td>
</tr>
<tr>
<td></td>
<td>accelerate</td>
<td>1.12.0</td>
</tr>
<tr>
<td></td>
<td>safetensors</td>
<td>&gt;= 0.7.0</td>
</tr>
<tr>
<td><strong>MiniCPM-o</strong></td>
<td>minicpmo-utils[all]</td>
<td>&gt;= 1.0.5</td>
</tr>
<tr>
<td><strong>Web 服务</strong></td>
<td>fastapi</td>
<td>&gt;= 0.128.0</td>
</tr>
<tr>
<td></td>
<td>uvicorn</td>
<td>&gt;= 0.40.0</td>
</tr>
<tr>
<td></td>
<td>httpx</td>
<td>&gt;= 0.28.0</td>
</tr>
<tr>
<td></td>
<td>websockets</td>
<td>&gt;= 16.0</td>
</tr>
<tr>
<td></td>
<td>python-multipart</td>
<td>—</td>
</tr>
<tr>
<td><strong>数据</strong></td>
<td>pydantic</td>
<td>&gt;= 2.11.0</td>
</tr>
<tr>
<td></td>
<td>numpy</td>
<td>&gt;= 2.2.0</td>
</tr>
<tr>
<td><strong>工具</strong></td>
<td>tqdm</td>
<td>&gt;= 4.67.0</td>
</tr>
<tr>
<td><strong>测试</strong></td>
<td>pytest</td>
<td>&gt;= 9.0.0</td>
</tr>
<tr>
<td></td>
<td>pytest-asyncio</td>
<td>&gt;= 1.3.0</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="_6">配置说明</h2>
<h3 id="configjson">config.json</h3>
<p>所有配置集中在项目根目录的 <code>config.json</code> 文件中。首次使用时从 <code>config.example.json</code> 复制：</p>
<div class="codehilite"><pre><span></span><code>cp<span class="w"> </span>config.example.json<span class="w"> </span>config.json
</code></pre></div>

<p><code>config.json</code> 已在 <code>.gitignore</code> 中，不会被提交。</p>
<h3 id="_7">配置优先级</h3>
<div class="codehilite"><pre><span></span><code>CLI 参数 &gt; config.json &gt; Pydantic 默认值
</code></pre></div>

<h3 id="_8">完整字段说明</h3>
<h4 id="model">model — 模型配置</h4>
<table>
<thead>
<tr>
<th>字段</th>
<th>类型</th>
<th>默认值</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>model_path</code></td>
<td>str</td>
<td><em>(必填)</em></td>
<td>HuggingFace 格式模型目录或 Hub ID</td>
</tr>
<tr>
<td><code>pt_path</code></td>
<td>str</td>
<td>null</td>
<td>额外 .pt 权重覆盖路径</td>
</tr>
<tr>
<td><code>attn_implementation</code></td>
<td>str</td>
<td><code>"auto"</code></td>
<td>Attention 实现方式</td>
</tr>
</tbody>
</table>
<h4 id="audio">audio — 音频配置</h4>
<table>
<thead>
<tr>
<th>字段</th>
<th>类型</th>
<th>默认值</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>ref_audio_path</code></td>
<td>str</td>
<td><code>assets/ref_audio/ref_minicpm_signature.wav</code></td>
<td>默认 TTS 参考音频路径</td>
</tr>
<tr>
<td><code>playback_delay_ms</code></td>
<td>int</td>
<td>200</td>
<td>前端音频播放延迟（ms），越大越平滑但延迟越高</td>
</tr>
</tbody>
</table>
<h4 id="service">service — 服务配置</h4>
<table>
<thead>
<tr>
<th>字段</th>
<th>类型</th>
<th>默认值</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>gateway_port</code></td>
<td>int</td>
<td>8006</td>
<td>Gateway 监听端口</td>
</tr>
<tr>
<td><code>worker_base_port</code></td>
<td>int</td>
<td>22400</td>
<td>Worker 起始端口（Worker N = base + N）</td>
</tr>
<tr>
<td><code>max_queue_size</code></td>
<td>int</td>
<td>1000</td>
<td>最大排队请求数</td>
</tr>
<tr>
<td><code>request_timeout</code></td>
<td>float</td>
<td>300.0</td>
<td>请求超时（秒）</td>
</tr>
<tr>
<td><code>compile</code></td>
<td>bool</td>
<td>false</td>
<td>启用 torch.compile 加速</td>
</tr>
<tr>
<td><code>data_dir</code></td>
<td>str</td>
<td><code>"data"</code></td>
<td>数据存储目录</td>
</tr>
<tr>
<td><code>eta_chat_s</code></td>
<td>float</td>
<td>15.0</td>
<td>Chat 任务基准 ETA（秒）</td>
</tr>
<tr>
<td><code>eta_streaming_s</code></td>
<td>float</td>
<td>20.0</td>
<td>Streaming 任务基准 ETA（秒）</td>
</tr>
<tr>
<td><code>eta_audio_duplex_s</code></td>
<td>float</td>
<td>120.0</td>
<td>Audio Duplex 任务基准 ETA（秒）</td>
</tr>
<tr>
<td><code>eta_omni_duplex_s</code></td>
<td>float</td>
<td>90.0</td>
<td>Omni Duplex 任务基准 ETA（秒）</td>
</tr>
<tr>
<td><code>eta_ema_alpha</code></td>
<td>float</td>
<td>0.3</td>
<td>ETA EMA 平滑系数</td>
</tr>
<tr>
<td><code>eta_ema_min_samples</code></td>
<td>int</td>
<td>3</td>
<td>ETA EMA 最少样本数</td>
</tr>
</tbody>
</table>
<h4 id="duplex">duplex — 双工配置</h4>
<table>
<thead>
<tr>
<th>字段</th>
<th>类型</th>
<th>默认值</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>pause_timeout</code></td>
<td>float</td>
<td>60.0</td>
<td>Duplex 暂停超时（秒），超时后自动释放 Worker</td>
</tr>
</tbody>
</table>
<h3 id="_9">最小配置</h3>
<div class="codehilite"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;model&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;model_path&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;openbmb/MiniCPM-o-4_5&quot;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="_10">完整配置示例</h3>
<div class="codehilite"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;model&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;model_path&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;openbmb/MiniCPM-o-4_5&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;pt_path&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;attn_implementation&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;auto&quot;</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nt">&quot;audio&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;ref_audio_path&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;assets/ref_audio/ref_minicpm_signature.wav&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;playback_delay_ms&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">200</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;chat_vocoder&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;token2wav&quot;</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nt">&quot;service&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;gateway_port&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">8006</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;worker_base_port&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">22400</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;max_queue_size&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1000</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;request_timeout&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">300.0</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;compile&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;data_dir&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;data&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;eta_chat_s&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">15.0</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;eta_streaming_s&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">20.0</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;eta_audio_duplex_s&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">120.0</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;eta_omni_duplex_s&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">90.0</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;eta_ema_alpha&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">0.3</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;eta_ema_min_samples&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">3</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nt">&quot;duplex&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;pause_timeout&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">60.0</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<hr />
<h2 id="attention-backend">Attention Backend</h2>
<p>控制模型推理使用的 Attention 实现，通过 <code>attn_implementation</code> 字段配置。</p>
<table>
<thead>
<tr>
<th>值</th>
<th>行为</th>
<th>适用场景</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>"auto"</code>（默认）</td>
<td>检测到 flash-attn → <code>flash_attention_2</code>；否则 → <code>sdpa</code></td>
<td>推荐</td>
</tr>
<tr>
<td><code>"flash_attention_2"</code></td>
<td>强制使用 Flash Attention 2</td>
<td>确认已安装 flash-attn</td>
</tr>
<tr>
<td><code>"sdpa"</code></td>
<td>PyTorch 内置 SDPA</td>
<td>无法编译 flash-attn</td>
</tr>
<tr>
<td><code>"eager"</code></td>
<td>朴素 Attention</td>
<td>仅 debug</td>
</tr>
</tbody>
</table>
<p><strong>性能对比</strong>（A100）：<code>flash_attention_2</code> 比 <code>sdpa</code> 快约 5-15%，<code>sdpa</code> 比 <code>eager</code> 快数倍。</p>
<p><strong>注意</strong>：Audio（Whisper）子模块始终使用 SDPA（与 flash_attention_2 不兼容）。Vision / LLM / TTS 遵循配置。</p>
<hr />
<h2 id="_11">启动与停止</h2>
<h3 id="start_allsh">一键启动（start_all.sh）</h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># 使用所有可用 GPU</span>
<span class="nv">CUDA_VISIBLE_DEVICES</span><span class="o">=</span><span class="m">0</span>,1,2,3<span class="w"> </span>bash<span class="w"> </span>start_all.sh

<span class="c1"># 指定 GPU</span>
<span class="nv">CUDA_VISIBLE_DEVICES</span><span class="o">=</span><span class="m">0</span>,1<span class="w"> </span>bash<span class="w"> </span>start_all.sh

<span class="c1"># 启用 torch.compile（实验性）</span>
bash<span class="w"> </span>start_all.sh<span class="w"> </span>--compile

<span class="c1"># 降级为 HTTP（不推荐，麦克风/摄像头 API 需要 HTTPS）</span>
bash<span class="w"> </span>start_all.sh<span class="w"> </span>--http
</code></pre></div>

<p><code>start_all.sh</code> 执行流程：
1. 解析命令行参数（<code>--http</code>, <code>--compile</code>）
2. 从 <code>config.py</code> 读取端口配置
3. 检测可用 GPU 数量
4. 为每个 GPU 启动一个 Worker 进程（<code>nohup</code>）
5. 等待所有 Worker 健康检查通过
6. 启动 Gateway 进程
7. 输出访问地址和日志路径</p>
<h3 id="_12">手动启动</h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># Worker（每张 GPU 一个）</span>
<span class="nv">CUDA_VISIBLE_DEVICES</span><span class="o">=</span><span class="m">0</span><span class="w"> </span><span class="nv">PYTHONPATH</span><span class="o">=</span>.<span class="w"> </span>.venv/base/bin/python<span class="w"> </span>worker.py<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--worker-index<span class="w"> </span><span class="m">0</span><span class="w"> </span>--gpu-id<span class="w"> </span><span class="m">0</span>

<span class="c1"># Gateway</span>
<span class="nv">PYTHONPATH</span><span class="o">=</span>.<span class="w"> </span>.venv/base/bin/python<span class="w"> </span>gateway.py<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--port<span class="w"> </span><span class="m">8006</span><span class="w"> </span>--workers<span class="w"> </span>localhost:22400
</code></pre></div>

<h3 id="cli">CLI 参数</h3>
<p><strong>Worker 参数</strong>：</p>
<div class="codehilite"><pre><span></span><code>python<span class="w"> </span>worker.py<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--model-path<span class="w"> </span>/path/to/model<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--pt-path<span class="w"> </span>/path/to/weights.pt<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--ref-audio-path<span class="w"> </span>/path/to/ref.wav<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--worker-index<span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--gpu-id<span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--compile
</code></pre></div>

<p><strong>Gateway 参数</strong>：</p>
<div class="codehilite"><pre><span></span><code>python<span class="w"> </span>gateway.py<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--port<span class="w"> </span><span class="m">8006</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--workers<span class="w"> </span>localhost:22400,localhost:22401<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--http
</code></pre></div>

<h3 id="_13">停止服务</h3>
<div class="codehilite"><pre><span></span><code>pkill<span class="w"> </span>-f<span class="w"> </span><span class="s2">&quot;gateway.py|worker.py&quot;</span>
</code></pre></div>

<hr />
<h2 id="_14">模型下载</h2>
<h3 id="_15">自动下载（默认）</h3>
<p><code>model_path</code> 设为 <code>openbmb/MiniCPM-o-4_5</code> 时，首次启动自动从 HuggingFace 下载。</p>
<h3 id="_16">手动下载</h3>
<p><strong>HuggingFace CLI</strong>：</p>
<div class="codehilite"><pre><span></span><code>pip<span class="w"> </span>install<span class="w"> </span>-U<span class="w"> </span>huggingface_hub
huggingface-cli<span class="w"> </span>download<span class="w"> </span>openbmb/MiniCPM-o-4_5<span class="w"> </span>--local-dir<span class="w"> </span>/path/to/MiniCPM-o-4_5
</code></pre></div>

<p><strong>hf-mirror（中国）</strong>：</p>
<div class="codehilite"><pre><span></span><code><span class="nb">export</span><span class="w"> </span><span class="nv">HF_ENDPOINT</span><span class="o">=</span>https://hf-mirror.com
huggingface-cli<span class="w"> </span>download<span class="w"> </span>openbmb/MiniCPM-o-4_5<span class="w"> </span>--local-dir<span class="w"> </span>/path/to/MiniCPM-o-4_5
</code></pre></div>

<p><strong>ModelScope（中国）</strong>：</p>
<div class="codehilite"><pre><span></span><code>pip<span class="w"> </span>install<span class="w"> </span>modelscope
modelscope<span class="w"> </span>download<span class="w"> </span>--model<span class="w"> </span>OpenBMB/MiniCPM-o-4_5<span class="w"> </span>--local_dir<span class="w"> </span>/path/to/MiniCPM-o-4_5
</code></pre></div>

<hr />
<h2 id="_17">测试</h2>
<h3 id="schema-gpu">Schema 单元测试（无需 GPU）</h3>
<div class="codehilite"><pre><span></span><code><span class="nv">PYTHONPATH</span><span class="o">=</span>.<span class="w"> </span>.venv/base/bin/python<span class="w"> </span>-m<span class="w"> </span>pytest<span class="w"> </span>tests/test_schemas.py<span class="w"> </span>-v
</code></pre></div>

<h3 id="processor-gpu">Processor 测试（需要 GPU）</h3>
<div class="codehilite"><pre><span></span><code><span class="nv">CUDA_VISIBLE_DEVICES</span><span class="o">=</span><span class="m">0</span><span class="w"> </span><span class="nv">PYTHONPATH</span><span class="o">=</span>.<span class="w"> </span>.venv/base/bin/python<span class="w"> </span>-m<span class="w"> </span>pytest<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>tests/test_chat.py<span class="w"> </span>tests/test_streaming.py<span class="w"> </span>tests/test_duplex.py<span class="w"> </span>-v<span class="w"> </span>-s
</code></pre></div>

<h3 id="api">API 集成测试（需要先启动服务）</h3>
<div class="codehilite"><pre><span></span><code><span class="nv">PYTHONPATH</span><span class="o">=</span>.<span class="w"> </span>.venv/base/bin/python<span class="w"> </span>-m<span class="w"> </span>pytest<span class="w"> </span>tests/test_api.py<span class="w"> </span>-v<span class="w"> </span>-s
</code></pre></div>

<h3 id="_18">测试文件说明</h3>
<table>
<thead>
<tr>
<th>文件</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>test_schemas.py</code></td>
<td>Schema 单元测试</td>
</tr>
<tr>
<td><code>test_chat.py</code></td>
<td>Chat 推理测试</td>
</tr>
<tr>
<td><code>test_streaming.py</code></td>
<td>Streaming 推理测试</td>
</tr>
<tr>
<td><code>test_duplex.py</code></td>
<td>Duplex 推理测试</td>
</tr>
<tr>
<td><code>test_api.py</code></td>
<td>API 集成测试</td>
</tr>
<tr>
<td><code>test_queue.py</code></td>
<td>队列逻辑测试</td>
</tr>
<tr>
<td><code>test_queue_stress.py</code></td>
<td>队列压力测试</td>
</tr>
<tr>
<td><code>test_integration.py</code></td>
<td>集成测试</td>
</tr>
<tr>
<td><code>test_e2e.py</code></td>
<td>端到端测试</td>
</tr>
<tr>
<td><code>bench_duplex_ws.py</code></td>
<td>Duplex WebSocket 性能基准测试</td>
</tr>
<tr>
<td><code>mock_worker.py</code></td>
<td>Mock Worker（用于无 GPU 测试）</td>
</tr>
<tr>
<td><code>js/queue-scenario.test.js</code></td>
<td>前端队列场景测试（Vitest）</td>
</tr>
<tr>
<td><code>js/countdown-timer.test.js</code></td>
<td>倒计时组件测试（Vitest）</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="_19">运行时目录结构</h2>
<div class="codehilite"><pre><span></span><code><span class="n">data</span><span class="o">/</span>
<span class="err">├──</span><span class="w"> </span><span class="n">sessions</span><span class="o">/</span><span class="w">                  </span><span class="p">#</span><span class="w"> </span><span class="err">会话录制数据</span>
<span class="err">│</span><span class="w">   </span><span class="err">├──</span><span class="w"> </span><span class="n">omni_abc123</span><span class="o">/</span>
<span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">   </span><span class="err">├──</span><span class="w"> </span><span class="n">meta</span><span class="p">.</span><span class="n">json</span>
<span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">   </span><span class="err">├──</span><span class="w"> </span><span class="n">recording</span><span class="p">.</span><span class="n">json</span>
<span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">   </span><span class="err">├──</span><span class="w"> </span><span class="n">user_audio</span><span class="o">/</span>
<span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">   </span><span class="err">├──</span><span class="w"> </span><span class="n">ai_audio</span><span class="o">/</span>
<span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">   </span><span class="err">└──</span><span class="w"> </span><span class="p">...</span>
<span class="err">│</span><span class="w">   </span><span class="err">└──</span><span class="w"> </span><span class="p">...</span>
<span class="err">└──</span><span class="w"> </span><span class="n">ref_audio</span><span class="o">/</span><span class="w">                 </span><span class="p">#</span><span class="w"> </span><span class="err">上传的参考音频</span>
<span class="w">    </span><span class="err">├──</span><span class="w"> </span><span class="n">registry</span><span class="p">.</span><span class="n">json</span>
<span class="w">    </span><span class="err">└──</span><span class="w"> </span><span class="o">*</span><span class="p">.</span><span class="n">wav</span>

<span class="n">tmp</span><span class="o">/</span>
<span class="err">├──</span><span class="w"> </span><span class="n">gateway</span><span class="p">.</span><span class="n">pid</span><span class="w">                </span><span class="p">#</span><span class="w"> </span><span class="n">Gateway</span><span class="w"> </span><span class="err">进程</span><span class="w"> </span><span class="n">PID</span>
<span class="err">├──</span><span class="w"> </span><span class="n">gateway</span><span class="p">.</span><span class="n">log</span><span class="w">                </span><span class="p">#</span><span class="w"> </span><span class="n">Gateway</span><span class="w"> </span><span class="err">日志</span>
<span class="err">├──</span><span class="w"> </span><span class="n">worker_0</span><span class="p">.</span><span class="n">pid</span><span class="w">               </span><span class="p">#</span><span class="w"> </span><span class="n">Worker</span><span class="w"> </span><span class="mh">0</span><span class="w"> </span><span class="n">PID</span>
<span class="err">├──</span><span class="w"> </span><span class="n">worker_0</span><span class="p">.</span><span class="n">log</span><span class="w">               </span><span class="p">#</span><span class="w"> </span><span class="n">Worker</span><span class="w"> </span><span class="mh">0</span><span class="w"> </span><span class="err">日志</span>
<span class="err">└──</span><span class="w"> </span><span class="n">diag_omni_</span><span class="o">*</span><span class="p">.</span><span class="n">jsonl</span><span class="w">          </span><span class="p">#</span><span class="w"> </span><span class="err">诊断日志</span>
</code></pre></div></article>
  <footer><p>MiniCPM-o 4.5 PyTorch Simple Demo &mdash; 由 build_docs.py 自动生成</p></footer>
</main>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/python.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/bash.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/json.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/javascript.min.js"></script>
<script type="module">
import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.esm.min.mjs';
mermaid.initialize({startOnLoad:true,theme:'default',securityLevel:'loose'});
</script>
<script>
hljs.highlightAll();
function toggleSidebar(){document.getElementById('sidebar').classList.toggle('open');document.getElementById('content').classList.toggle('shifted');}
document.querySelectorAll('.nav-group-header').forEach(function(h){h.addEventListener('click',function(){this.parentElement.classList.toggle('collapsed');});});
document.addEventListener('click',function(e){var s=document.getElementById('sidebar'),t=document.querySelector('.sidebar-toggle');if(window.innerWidth<=768&&s.classList.contains('open')&&!s.contains(e.target)&&!t.contains(e.target)){s.classList.remove('open');document.getElementById('content').classList.remove('shifted');}});
</script>
</body>
</html>
