<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Gateway 模块 - MiniCPM-o 4.5 文档</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">
<style>
* { margin:0; padding:0; box-sizing:border-box; }
:root {
  --sidebar-w: 260px;
  --bg: #fff; --bg-side: #f8f9fa; --bg-code: #f6f8fa;
  --c1: #24292f; --c2: #57606a;
  --border: #d0d7de; --accent: #0969da; --nav-active: #ddf4ff;
}
body { font-family: -apple-system,BlinkMacSystemFont,"Segoe UI","Noto Sans",Helvetica,Arial,sans-serif; color:var(--c1); line-height:1.6; background:var(--bg); }
.sidebar-toggle { position:fixed; top:12px; left:12px; z-index:1001; background:var(--bg-side); border:1px solid var(--border); border-radius:6px; padding:6px 10px; font-size:18px; cursor:pointer; display:none; }
.sidebar { position:fixed; top:0; left:0; width:var(--sidebar-w); height:100vh; overflow-y:auto; background:var(--bg-side); border-right:1px solid var(--border); padding:20px 0; z-index:1000; transition:transform .3s; }
.sidebar-header { padding:0 20px 16px; border-bottom:1px solid var(--border); margin-bottom:8px; }
.sidebar-header h2 { font-size:16px; font-weight:600; }
.sidebar-subtitle { font-size:12px; color:var(--c2); }
.lang-switch { display:inline-block; margin-top:6px; font-size:12px; color:var(--accent); text-decoration:none; padding:2px 8px; border:1px solid var(--border); border-radius:4px; transition:background .15s; }
.lang-switch:hover { background:var(--nav-active); text-decoration:none; }

.nav-list { list-style:none; padding:0 8px; }
.nav-list > li > a { display:block; padding:7px 12px; color:var(--c2); text-decoration:none; font-size:14px; border-radius:6px; transition:background .15s,color .15s; }
.nav-list > li > a:hover { background:#e8e8e8; color:var(--c1); }
.nav-list > li > a.active { background:var(--nav-active); color:var(--accent); font-weight:600; }

.nav-group { margin-top:4px; }
.nav-group-header { display:flex; align-items:center; gap:6px; padding:8px 12px; color:var(--c1); font-size:12px; font-weight:700; text-transform:uppercase; letter-spacing:.04em; cursor:pointer; border-radius:6px; user-select:none; transition:background .15s; }
.nav-group-header:hover { background:#eaeef2; }
.nav-group-header::before { content:""; display:inline-block; width:0; height:0; border-left:5px solid var(--c2); border-top:3.5px solid transparent; border-bottom:3.5px solid transparent; transition:transform .2s; transform:rotate(90deg); flex-shrink:0; }
.nav-group.collapsed .nav-group-header::before { transform:rotate(0); }
.nav-group-children { list-style:none; margin:0 0 4px 19px; padding:3px 0 3px 13px; border-left:2px solid #e1e4e8; overflow:hidden; max-height:500px; transition:max-height .25s ease,opacity .2s ease,padding .2s ease; opacity:1; }
.nav-group.collapsed .nav-group-children { max-height:0; opacity:0; padding:0 0 0 13px; }
.nav-group-children li a { display:block; padding:4px 10px; font-size:13px; color:var(--c2); text-decoration:none; border-radius:4px; transition:background .15s,color .15s; }
.nav-group-children li a:hover { background:#e8e8e8; color:var(--c1); }
.nav-group-children li a.active { background:var(--nav-active); color:var(--accent); font-weight:600; }

.content { margin-left:var(--sidebar-w); max-width:900px; padding:40px 48px; }
article h1 { font-size:28px; font-weight:600; padding-bottom:10px; border-bottom:1px solid var(--border); margin-bottom:20px; }
article h2 { font-size:22px; font-weight:600; margin-top:32px; margin-bottom:12px; padding-bottom:6px; border-bottom:1px solid #eaecef; }
article h3 { font-size:18px; font-weight:600; margin-top:24px; margin-bottom:10px; }
article h4 { font-size:15px; font-weight:600; margin-top:20px; margin-bottom:8px; }
article p { margin-bottom:14px; }
article ul,article ol { margin-bottom:14px; padding-left:24px; }
article li { margin-bottom:4px; }
article a { color:var(--accent); text-decoration:none; }
article a:hover { text-decoration:underline; }
article code { background:var(--bg-code); padding:2px 6px; border-radius:4px; font-size:13px; font-family:"SFMono-Regular",Consolas,"Liberation Mono",Menlo,monospace; }
article pre { background:var(--bg-code); border:1px solid var(--border); border-radius:6px; padding:16px; overflow-x:auto; margin-bottom:16px; line-height:1.5; }
article pre code { background:none; padding:0; font-size:13px; }
article table { width:100%; border-collapse:collapse; margin-bottom:16px; font-size:14px; }
article th,article td { border:1px solid var(--border); padding:8px 12px; text-align:left; }
article th { background:var(--bg-code); font-weight:600; }
article tr:nth-child(even) { background:#f8f9fa; }
article hr { border:none; border-top:1px solid var(--border); margin:28px 0; }
article blockquote { border-left:4px solid var(--accent); padding:8px 16px; margin:0 0 16px; color:var(--c2); background:#f8f9fa; border-radius:0 6px 6px 0; }
article .mermaid { text-align:center; margin:20px 0; }
footer { margin-top:60px; padding-top:16px; border-top:1px solid var(--border); color:var(--c2); font-size:13px; }
@media(max-width:768px) {
  .sidebar { transform:translateX(-100%); }
  .sidebar.open { transform:translateX(0); box-shadow:2px 0 8px rgba(0,0,0,.15); }
  .sidebar-toggle { display:block; }
  .content { margin-left:0; padding:50px 20px 40px; }
  .content.shifted { margin-left:var(--sidebar-w); }
}
</style>
</head>
<body>
<button class="sidebar-toggle" onclick="toggleSidebar()" aria-label="Toggle sidebar">&#9776;</button>
<nav class="sidebar" id="sidebar">
  <div class="sidebar-header">
    <h2>MiniCPM-o 4.5</h2>
    <span class="sidebar-subtitle">项目文档</span>
    <a href="../en/gateway.html" class="lang-switch">English</a>
  </div>
  <ul class="nav-list">
    <li><a href="index.html">项目概述</a></li>
    <li class="nav-group">
      <span class="nav-group-header">系统架构</span>
      <ul class="nav-group-children">
        <li><a href="architecture/index.html">架构概述</a></li>
        <li><a href="architecture/streaming.html">Chat 模式</a></li>
        <li><a href="architecture/duplex.html">Duplex 模式</a></li>
        <li><a href="architecture/internals.html">内部机制</a></li>
      </ul>
    </li>
    <li><a href="gateway.html" class="active">Gateway 模块</a></li>
    <li><a href="worker.html">Worker 模块</a></li>
    <li><a href="schema.html">Schema</a></li>
    <li><a href="model.html">模型模块</a></li>
    <li><a href="compile.html">torch.compile</a></li>
    <li class="nav-group">
      <span class="nav-group-header">前端模块</span>
      <ul class="nav-group-children">
        <li><a href="frontend/index.html">前端概述</a></li>
        <li><a href="frontend/pages.html">页面与路由</a></li>
        <li><a href="frontend/audio.html">音频处理</a></li>
        <li><a href="frontend/duplex-session.html">双工会话</a></li>
        <li><a href="frontend/components.html">UI 组件</a></li>
      </ul>
    </li>
    <li><a href="api.html">API 参考</a></li>
    <li><a href="deployment.html">配置与部署</a></li>
  </ul>
</nav>
<main class="content" id="content">
  <article><h1 id="gateway">Gateway 模块详解</h1>
<p>Gateway 是系统的请求入口和路由中枢，不加载模型，负责请求分发、WebSocket 代理、队列管理和资源管理。</p>
<h2 id="_1">模块结构</h2>
<div class="codehilite"><pre><span></span><code><span class="n">gateway</span><span class="p">.</span><span class="n">py</span><span class="w">                         </span><span class="p">#</span><span class="w"> </span><span class="n">Gateway</span><span class="w"> </span><span class="err">主服务</span>
<span class="n">gateway_modules</span><span class="o">/</span>
<span class="err">├──</span><span class="w"> </span><span class="n">__init__</span><span class="p">.</span><span class="n">py</span><span class="w">                    </span><span class="p">#</span><span class="w"> </span><span class="err">包标识</span>
<span class="err">├──</span><span class="w"> </span><span class="n">worker_pool</span><span class="p">.</span><span class="n">py</span><span class="w">                 </span><span class="p">#</span><span class="w"> </span><span class="n">WorkerPool</span><span class="w"> </span><span class="err">调度器</span>
<span class="err">├──</span><span class="w"> </span><span class="n">app_registry</span><span class="p">.</span><span class="n">py</span><span class="w">                </span><span class="p">#</span><span class="w"> </span><span class="err">应用注册表</span>
<span class="err">├──</span><span class="w"> </span><span class="n">models</span><span class="p">.</span><span class="n">py</span><span class="w">                      </span><span class="p">#</span><span class="w"> </span><span class="err">数据模型定义</span>
<span class="err">└──</span><span class="w"> </span><span class="n">ref_audio_registry</span><span class="p">.</span><span class="n">py</span><span class="w">          </span><span class="p">#</span><span class="w"> </span><span class="err">参考音频注册表</span>
</code></pre></div>

<h2 id="gatewaypy">gateway.py — 主服务</h2>
<p>Gateway 基于 <strong>FastAPI</strong> 构建，使用 <strong>uvicorn</strong> 运行，提供 HTTP REST API 和 WebSocket 端点。</p>
<h3 id="_2">生命周期管理</h3>
<p><code>lifespan()</code> 异步上下文管理器负责：
1. 从 <code>config.py</code> 加载配置
2. 初始化 <code>WorkerPool</code> 并启动健康检查
3. 初始化 <code>RefAudioRegistry</code> 和 <code>AppRegistry</code>
4. 启动后台 session 清理任务（每天执行一次）
5. 配置 HTTPS（自签名证书）或 HTTP 模式</p>
<h3 id="_3">核心路由</h3>
<h4 id="http">HTTP 端点</h4>
<table>
<thead>
<tr>
<th>端点</th>
<th>方法</th>
<th>功能</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>/health</code></td>
<td>GET</td>
<td>健康检查</td>
</tr>
<tr>
<td><code>/status</code></td>
<td>GET</td>
<td>服务全局状态</td>
</tr>
<tr>
<td><code>/workers</code></td>
<td>GET</td>
<td>Worker 列表</td>
</tr>
<tr>
<td><code>/api/chat</code></td>
<td>POST</td>
<td>Chat 推理（无状态）</td>
</tr>
<tr>
<td><code>/api/streaming/stop</code></td>
<td>POST</td>
<td>停止 Streaming 生成</td>
</tr>
<tr>
<td><code>/api/frontend_defaults</code></td>
<td>GET</td>
<td>前端默认配置</td>
</tr>
<tr>
<td><code>/api/presets</code></td>
<td>GET</td>
<td>System Prompt 预设列表</td>
</tr>
<tr>
<td><code>/api/default_ref_audio</code></td>
<td>GET</td>
<td>默认参考音频</td>
</tr>
<tr>
<td><code>/api/assets/ref_audio</code></td>
<td>GET</td>
<td>参考音频列表</td>
</tr>
<tr>
<td><code>/api/assets/ref_audio/external</code></td>
<td>POST</td>
<td>上传参考音频</td>
</tr>
<tr>
<td><code>/api/assets/ref_audio/{id}</code></td>
<td>DELETE</td>
<td>删除参考音频</td>
</tr>
<tr>
<td><code>/api/queue</code></td>
<td>GET</td>
<td>队列状态</td>
</tr>
<tr>
<td><code>/api/queue/{ticket_id}</code></td>
<td>GET/DELETE</td>
<td>查询/取消排队项</td>
</tr>
<tr>
<td><code>/api/config/eta</code></td>
<td>GET/PUT</td>
<td>ETA 配置管理</td>
</tr>
<tr>
<td><code>/api/cache</code></td>
<td>GET</td>
<td>KV Cache 状态</td>
</tr>
<tr>
<td><code>/api/sessions/{sid}</code></td>
<td>GET</td>
<td>会话元数据</td>
</tr>
<tr>
<td><code>/api/sessions/{sid}/recording</code></td>
<td>GET</td>
<td>会话录制数据</td>
</tr>
<tr>
<td><code>/api/sessions/{sid}/assets/{rel}</code></td>
<td>GET</td>
<td>会话资源文件</td>
</tr>
<tr>
<td><code>/api/sessions/{sid}/download</code></td>
<td>GET</td>
<td>下载会话</td>
</tr>
<tr>
<td><code>/api/sessions/{sid}/upload-recording</code></td>
<td>POST</td>
<td>上传前端录制</td>
</tr>
<tr>
<td><code>/api/apps</code></td>
<td>GET</td>
<td>已启用应用列表</td>
</tr>
<tr>
<td><code>/api/admin/apps</code></td>
<td>GET/PUT</td>
<td>应用管理（Admin）</td>
</tr>
</tbody>
</table>
<h4 id="websocket">WebSocket 端点</h4>
<table>
<thead>
<tr>
<th>端点</th>
<th>功能</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>/ws/chat</code></td>
<td>Chat WebSocket 代理</td>
</tr>
<tr>
<td><code>/ws/duplex/{session_id}</code></td>
<td>Duplex 全双工会话代理</td>
</tr>
</tbody>
</table>
<h3 id="websocket_1">WebSocket 代理机制</h3>
<p><strong>Streaming 代理</strong>：
1. 接收客户端 WebSocket 连接
2. 将请求入队 <code>WorkerPool.enqueue("chat")</code>
3. 排队期间向客户端推送 <code>queued</code> / <code>queue_update</code> 消息
4. 获取到 Worker 后，建立到 Worker 的 WebSocket 连接
5. 双向转发消息（client ↔ worker）
6. 完成后释放 Worker</p>
<p><strong>Duplex 代理</strong>：
1. 接收客户端 WebSocket 连接
2. 将请求入队 <code>WorkerPool.enqueue("omni_duplex" / "audio_duplex")</code>
3. 获取到 Worker 后独占该 Worker
4. 启动两个并行任务：<code>client_to_worker</code> 和 <code>worker_to_client</code>
5. 客户端断开或发送 <code>stop</code> 后清理释放</p>
<h3 id="_4">安全措施</h3>
<ul>
<li>Session ID 通过正则 <code>^[a-zA-Z0-9_-]{1,64}$</code> 校验，防止路径遍历</li>
<li>上传文件大小限制 200MB</li>
<li>HTTPS 默认启用（自签名证书）</li>
</ul>
<hr />
<h2 id="worker_poolpy-workerpool">worker_pool.py — WorkerPool 调度器</h2>
<p>WorkerPool 是 Gateway 的核心调度组件，管理所有 Worker 连接和请求分发。</p>
<h3 id="_5">核心类</h3>
<h4 id="workerconnection">WorkerConnection</h4>
<p>Worker 连接数据类，维护单个 Worker 的状态信息。</p>
<table>
<thead>
<tr>
<th>属性</th>
<th>类型</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>url</code></td>
<td>str</td>
<td>Worker 地址</td>
</tr>
<tr>
<td><code>index</code></td>
<td>int</td>
<td>Worker 序号</td>
</tr>
<tr>
<td><code>status</code></td>
<td>GatewayWorkerStatus</td>
<td>当前状态</td>
</tr>
<tr>
<td><code>current_task</code></td>
<td>str</td>
<td>当前任务类型</td>
</tr>
<tr>
<td><code>current_session_id</code></td>
<td>str</td>
<td>当前会话 ID</td>
</tr>
<tr>
<td><code>cached_hash</code></td>
<td>str</td>
<td>缓存的历史 hash</td>
</tr>
<tr>
<td><code>busy_since</code></td>
<td>datetime</td>
<td>忙碌开始时间</td>
</tr>
</tbody>
</table>
<p>关键方法：
- <code>mark_busy(task, session_id)</code> — 标记为忙碌
- <code>mark_idle()</code> — 标记为空闲，更新 <code>cached_hash</code>
- <code>update_duplex_status(status)</code> — 更新 Duplex 状态
- <code>to_info()</code> — 转换为 API 响应模型</p>
<h4 id="queueentry">QueueEntry</h4>
<p>队列条目，包含 <code>ticket</code>（排队凭证）、<code>future</code>（等待结果）和 <code>history_hash</code>（消息历史摘要）。</p>
<h4 id="etatracker">EtaTracker</h4>
<p>ETA 估算追踪器，结合基准值和 EMA（指数移动平均）动态估算等待时间。</p>
<ul>
<li><code>get_eta(task_type)</code> — 获取单任务预估耗时</li>
<li><code>record_duration(task_type, duration)</code> — 记录实际耗时，更新 EMA</li>
<li><code>update_config(config)</code> — 更新基准值</li>
</ul>
<h4 id="workerpool">WorkerPool</h4>
<table>
<thead>
<tr>
<th>方法</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>start()</code></td>
<td>启动健康检查循环</td>
</tr>
<tr>
<td><code>stop()</code></td>
<td>停止并清理</td>
</tr>
<tr>
<td><code>enqueue(task_type, history_hash)</code></td>
<td>入队请求，返回 (ticket, future)</td>
</tr>
<tr>
<td><code>release_worker(worker_url, cached_hash)</code></td>
<td>释放 Worker</td>
</tr>
<tr>
<td><code>cancel(ticket_id)</code></td>
<td>取消排队</td>
</tr>
<tr>
<td><code>get_ticket(ticket_id)</code></td>
<td>查询排队状态</td>
</tr>
<tr>
<td><code>get_queue_status()</code></td>
<td>队列快照</td>
</tr>
<tr>
<td><code>get_all_workers()</code></td>
<td>Worker 列表</td>
</tr>
</tbody>
</table>
<h3 id="fifo">FIFO 队列机制</h3>
<p>队列使用 <code>OrderedDict</code> 实现，所有请求类型（Chat / Streaming / Duplex）共享一个统一队列，保证公平的先到先服务。</p>
<p><strong>入队流程</strong>（<code>enqueue()</code>）：
1. 先尝试立即分配 — 如有空闲 Worker，<code>Future</code> 立刻 resolve，请求不进入队列
2. 无空闲 Worker 时检查容量（默认 1000），满则拒绝
3. 创建 <code>QueueEntry</code>（含 <code>QueueTicket</code> + <code>asyncio.Future</code>），追加到 OrderedDict 尾部</p>
<p><strong>调度流程</strong>（<code>_dispatch_next()</code>）— 唯一的 Worker 分配入口：
1. 取队头 Entry
2. 根据请求类型匹配空闲 Worker（Streaming 走 LRU 路由，其余走通用路由）
3. 找到 → 立即 <code>mark_busy()</code> + <code>future.set_result(worker)</code> + 移除队头
4. 循环直到无空闲 Worker 或队列为空</p>
<p><strong>触发时机</strong>：Worker 释放、排队取消、健康检查恢复 IDLE 后均触发 <code>_dispatch_next()</code>。</p>
<p><strong>Gateway ↔ Worker 通信</strong>：队列只负责 Worker 分配（决定哪个 Worker 处理哪个请求），不参与数据传输。Gateway 获得 Worker 引用后，直接通过 HTTP（Chat: <code>POST /chat</code>）或 WebSocket（Chat: <code>/ws/chat</code>、Duplex: <code>/ws/duplex</code>）连接 Worker 的内部端口（22400+）进行通信。</p>
<h3 id="eta">ETA 估算</h3>
<p><code>EtaTracker</code> 结合 Admin 配置的基准值和运行时 EMA（指数移动平均）动态估算等待时间：</p>
<ul>
<li>每种任务类型维护独立的基准值和 EMA 动态值</li>
<li>有足够样本（默认 &gt;= 3）时使用 EMA 值，否则用基准值</li>
<li><code>_recalc_positions_and_eta()</code> 使用最小堆模拟 dispatch 链，逐个弹出最早空闲的 Worker 分配给队头，精确计算每个排队者的等待时间</li>
<li>ETA 结果通过 WebSocket 实时推送给排队中的客户端</li>
</ul>
<h3 id="_6">健康检查</h3>
<p>每 10 秒轮询所有 Worker 的 <code>/health</code> 端点（<code>_health_check_loop()</code>），更新状态。健康检查后触发 <code>_dispatch_next()</code>（可能有 Worker 从 OFFLINE 恢复为 IDLE）。</p>
<p><strong>Gateway 调度权威</strong>：当 Gateway 已 dispatch 任务给 Worker（<code>_gateway_dispatched=True</code>）时，即使 Worker <code>/health</code> 暂时报告 <code>idle</code>（cleanup 瞬态），Gateway 也不会将其降级为 IDLE，防止误分配。<code>release_worker()</code> 清除此标记后健康检查恢复权威。</p>
<hr />
<h2 id="app_registrypy">app_registry.py — 应用注册表</h2>
<p>管理前端应用的启用/禁用状态，支持运行时动态切换。</p>
<h3 id="_7">默认应用</h3>
<table>
<thead>
<tr>
<th>ID</th>
<th>名称</th>
<th>默认状态</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>turnbased</code></td>
<td>Turn-based Chat</td>
<td>启用</td>
</tr>
<tr>
<td><code>omni</code></td>
<td>Omnimodal Full-Duplex</td>
<td>启用</td>
</tr>
<tr>
<td><code>audio_duplex</code></td>
<td>Audio Full-Duplex</td>
<td>启用</td>
</tr>
</tbody>
</table>
<h3 id="appregistry">AppRegistry 类</h3>
<table>
<thead>
<tr>
<th>方法</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>is_enabled(app_id)</code></td>
<td>检查应用是否启用</td>
</tr>
<tr>
<td><code>set_enabled(app_id, enabled)</code></td>
<td>设置启用状态</td>
</tr>
<tr>
<td><code>get_enabled_apps()</code></td>
<td>获取已启用应用列表</td>
</tr>
<tr>
<td><code>get_all_apps()</code></td>
<td>获取所有应用（Admin 用）</td>
</tr>
</tbody>
</table>
<p>通过 <code>threading.Lock</code> 保证线程安全。</p>
<hr />
<h2 id="modelspy-gateway">models.py — Gateway 数据模型</h2>
<p>为 Gateway 层定义所有 API 数据模型，基于 Pydantic。</p>
<h3 id="_8">枚举</h3>
<ul>
<li><strong>GatewayWorkerStatus</strong> — Worker 状态枚举：<code>idle</code> / <code>busy_streaming</code> / <code>duplex_active</code> / <code>duplex_paused</code> / <code>offline</code></li>
</ul>
<h3 id="_9">数据模型</h3>
<table>
<thead>
<tr>
<th>模型</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>WorkerInfo</code></td>
<td>Worker 信息（url, index, status, task, session_id, cached_hash, busy_since）</td>
</tr>
<tr>
<td><code>QueueTicket</code></td>
<td>排队凭证（ticket_id, position, eta_seconds, task_type）</td>
</tr>
<tr>
<td><code>QueueTicketSummary</code></td>
<td>简要凭证（ticket_id, position）</td>
</tr>
<tr>
<td><code>RunningTaskInfo</code></td>
<td>运行中任务（worker_url, task_type, session_id, started_at, elapsed_s）</td>
</tr>
<tr>
<td><code>QueueStatus</code></td>
<td>队列快照（queue_length, entries, running）</td>
</tr>
<tr>
<td><code>ServiceStatus</code></td>
<td>全局状态（total_workers, idle, busy, queue_length）</td>
</tr>
<tr>
<td><code>EtaConfig</code> / <code>EtaStatus</code></td>
<td>ETA 配置和状态</td>
</tr>
<tr>
<td><code>WorkersResponse</code></td>
<td>Worker 列表响应</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="ref_audio_registrypy">ref_audio_registry.py — 参考音频注册表</h2>
<p>管理 TTS 参考音频的存储和元数据。</p>
<h3 id="refaudioregistry">RefAudioRegistry 类</h3>
<table>
<thead>
<tr>
<th>方法</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>upload(name, audio_data, source)</code></td>
<td>上传参考音频（自动归一化为 16kHz mono 16-bit WAV）</td>
</tr>
<tr>
<td><code>get(audio_id)</code></td>
<td>查询音频信息</td>
</tr>
<tr>
<td><code>get_file_path(audio_id)</code></td>
<td>获取文件路径</td>
</tr>
<tr>
<td><code>get_base64(audio_id)</code></td>
<td>获取 Base64 编码</td>
</tr>
<tr>
<td><code>list_all()</code></td>
<td>列出所有参考音频</td>
</tr>
<tr>
<td><code>delete(audio_id)</code></td>
<td>删除参考音频</td>
</tr>
<tr>
<td><code>exists(audio_id)</code></td>
<td>检查是否存在</td>
</tr>
</tbody>
</table>
<p>音频上传时自动使用 <code>librosa</code> + <code>soundfile</code> 进行格式归一化。元数据持久化到 JSON 文件。</p></article>
  <footer><p>MiniCPM-o 4.5 PyTorch Simple Demo &mdash; 由 build_docs.py 自动生成</p></footer>
</main>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/python.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/bash.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/json.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/javascript.min.js"></script>
<script type="module">
import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.esm.min.mjs';
mermaid.initialize({startOnLoad:true,theme:'default',securityLevel:'loose'});
</script>
<script>
hljs.highlightAll();
function toggleSidebar(){document.getElementById('sidebar').classList.toggle('open');document.getElementById('content').classList.toggle('shifted');}
document.querySelectorAll('.nav-group-header').forEach(function(h){h.addEventListener('click',function(){this.parentElement.classList.toggle('collapsed');});});
document.addEventListener('click',function(e){var s=document.getElementById('sidebar'),t=document.querySelector('.sidebar-toggle');if(window.innerWidth<=768&&s.classList.contains('open')&&!s.contains(e.target)&&!t.contains(e.target)){s.classList.remove('open');document.getElementById('content').classList.remove('shifted');}});
</script>
</body>
</html>
