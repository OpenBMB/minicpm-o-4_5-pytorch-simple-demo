<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>API 参考 - MiniCPM-o 4.5 文档</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">
<style>
* { margin:0; padding:0; box-sizing:border-box; }
:root {
  --sidebar-w: 260px;
  --bg: #fff; --bg-side: #f8f9fa; --bg-code: #f6f8fa;
  --c1: #24292f; --c2: #57606a;
  --border: #d0d7de; --accent: #0969da; --nav-active: #ddf4ff;
}
body { font-family: -apple-system,BlinkMacSystemFont,"Segoe UI","Noto Sans",Helvetica,Arial,sans-serif; color:var(--c1); line-height:1.6; background:var(--bg); }
.sidebar-toggle { position:fixed; top:12px; left:12px; z-index:1001; background:var(--bg-side); border:1px solid var(--border); border-radius:6px; padding:6px 10px; font-size:18px; cursor:pointer; display:none; }
.sidebar { position:fixed; top:0; left:0; width:var(--sidebar-w); height:100vh; overflow-y:auto; background:var(--bg-side); border-right:1px solid var(--border); padding:20px 0; z-index:1000; transition:transform .3s; }
.sidebar-header { padding:0 20px 16px; border-bottom:1px solid var(--border); margin-bottom:8px; }
.sidebar-header h2 { font-size:16px; font-weight:600; }
.sidebar-subtitle { font-size:12px; color:var(--c2); }

.nav-list { list-style:none; padding:0 8px; }
.nav-list > li > a { display:block; padding:7px 12px; color:var(--c2); text-decoration:none; font-size:14px; border-radius:6px; transition:background .15s,color .15s; }
.nav-list > li > a:hover { background:#e8e8e8; color:var(--c1); }
.nav-list > li > a.active { background:var(--nav-active); color:var(--accent); font-weight:600; }

.nav-group { margin-top:4px; }
.nav-group-header { display:flex; align-items:center; gap:6px; padding:8px 12px; color:var(--c1); font-size:12px; font-weight:700; text-transform:uppercase; letter-spacing:.04em; cursor:pointer; border-radius:6px; user-select:none; transition:background .15s; }
.nav-group-header:hover { background:#eaeef2; }
.nav-group-header::before { content:""; display:inline-block; width:0; height:0; border-left:5px solid var(--c2); border-top:3.5px solid transparent; border-bottom:3.5px solid transparent; transition:transform .2s; transform:rotate(90deg); flex-shrink:0; }
.nav-group.collapsed .nav-group-header::before { transform:rotate(0); }
.nav-group-children { list-style:none; margin:0 0 4px 19px; padding:3px 0 3px 13px; border-left:2px solid #e1e4e8; overflow:hidden; max-height:500px; transition:max-height .25s ease,opacity .2s ease,padding .2s ease; opacity:1; }
.nav-group.collapsed .nav-group-children { max-height:0; opacity:0; padding:0 0 0 13px; }
.nav-group-children li a { display:block; padding:4px 10px; font-size:13px; color:var(--c2); text-decoration:none; border-radius:4px; transition:background .15s,color .15s; }
.nav-group-children li a:hover { background:#e8e8e8; color:var(--c1); }
.nav-group-children li a.active { background:var(--nav-active); color:var(--accent); font-weight:600; }

.content { margin-left:var(--sidebar-w); max-width:900px; padding:40px 48px; }
article h1 { font-size:28px; font-weight:600; padding-bottom:10px; border-bottom:1px solid var(--border); margin-bottom:20px; }
article h2 { font-size:22px; font-weight:600; margin-top:32px; margin-bottom:12px; padding-bottom:6px; border-bottom:1px solid #eaecef; }
article h3 { font-size:18px; font-weight:600; margin-top:24px; margin-bottom:10px; }
article h4 { font-size:15px; font-weight:600; margin-top:20px; margin-bottom:8px; }
article p { margin-bottom:14px; }
article ul,article ol { margin-bottom:14px; padding-left:24px; }
article li { margin-bottom:4px; }
article a { color:var(--accent); text-decoration:none; }
article a:hover { text-decoration:underline; }
article code { background:var(--bg-code); padding:2px 6px; border-radius:4px; font-size:13px; font-family:"SFMono-Regular",Consolas,"Liberation Mono",Menlo,monospace; }
article pre { background:var(--bg-code); border:1px solid var(--border); border-radius:6px; padding:16px; overflow-x:auto; margin-bottom:16px; line-height:1.5; }
article pre code { background:none; padding:0; font-size:13px; }
article table { width:100%; border-collapse:collapse; margin-bottom:16px; font-size:14px; }
article th,article td { border:1px solid var(--border); padding:8px 12px; text-align:left; }
article th { background:var(--bg-code); font-weight:600; }
article tr:nth-child(even) { background:#f8f9fa; }
article hr { border:none; border-top:1px solid var(--border); margin:28px 0; }
article blockquote { border-left:4px solid var(--accent); padding:8px 16px; margin:0 0 16px; color:var(--c2); background:#f8f9fa; border-radius:0 6px 6px 0; }
article .mermaid { text-align:center; margin:20px 0; }
footer { margin-top:60px; padding-top:16px; border-top:1px solid var(--border); color:var(--c2); font-size:13px; }
@media(max-width:768px) {
  .sidebar { transform:translateX(-100%); }
  .sidebar.open { transform:translateX(0); box-shadow:2px 0 8px rgba(0,0,0,.15); }
  .sidebar-toggle { display:block; }
  .content { margin-left:0; padding:50px 20px 40px; }
  .content.shifted { margin-left:var(--sidebar-w); }
}
</style>
</head>
<body>
<button class="sidebar-toggle" onclick="toggleSidebar()" aria-label="Toggle sidebar">&#9776;</button>
<nav class="sidebar" id="sidebar">
  <div class="sidebar-header">
    <h2>MiniCPM-o 4.5</h2>
    <span class="sidebar-subtitle">项目文档</span>
  </div>
  <ul class="nav-list">
    <li><a href="index.html">项目概述</a></li>
    <li><a href="architecture.html">系统架构</a></li>
    <li><a href="gateway.html">Gateway 模块</a></li>
    <li><a href="worker.html">Worker 模块</a></li>
    <li><a href="core.html">Core 模块</a></li>
    <li><a href="model.html">模型模块</a></li>
    <li><a href="compile.html">torch.compile</a></li>
    <li class="nav-group">
      <span class="nav-group-header">前端模块</span>
      <ul class="nav-group-children">
        <li><a href="frontend/index.html">前端概述</a></li>
        <li><a href="frontend/pages.html">页面与路由</a></li>
        <li><a href="frontend/audio.html">音频处理</a></li>
        <li><a href="frontend/duplex-session.html">双工会话</a></li>
        <li><a href="frontend/components.html">UI 组件</a></li>
      </ul>
    </li>
    <li><a href="api.html" class="active">API 参考</a></li>
    <li><a href="deployment.html">配置与部署</a></li>
  </ul>
</nav>
<main class="content" id="content">
  <article><h1 id="api">API 参考</h1>
<p>本文档列出系统提供的所有 HTTP REST API 和 WebSocket 协议。</p>
<p>Gateway 默认监听 <code>https://localhost:8006</code>。</p>
<hr />
<h2 id="http-rest-api">HTTP REST API</h2>
<h3 id="_1">健康与状态</h3>
<h4 id="get-health">GET /health</h4>
<p>健康检查。</p>
<p><strong>响应</strong>：</p>
<div class="codehilite"><pre><span></span><code><span class="p">{</span><span class="nt">&quot;status&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;ok&quot;</span><span class="p">}</span>
</code></pre></div>

<h4 id="get-status">GET /status</h4>
<p>服务全局状态。</p>
<p><strong>响应</strong>：</p>
<div class="codehilite"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;total_workers&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;idle_workers&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;busy_workers&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;queue_length&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;workers&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="err">...</span><span class="p">]</span>
<span class="p">}</span>
</code></pre></div>

<h4 id="get-workers">GET /workers</h4>
<p>Worker 列表。</p>
<p><strong>响应</strong>：</p>
<div class="codehilite"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;workers&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;url&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;http://localhost:22400&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;index&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;status&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;idle&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;current_task&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;current_session_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;cached_hash&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;abc123&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;busy_since&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">]</span>
<span class="p">}</span>
</code></pre></div>

<hr />
<h3 id="chat-api">Chat API</h3>
<h4 id="post-apichat">POST /api/chat</h4>
<p>无状态 Chat 推理。每次请求完整 prefill，不复用 KV Cache。</p>
<p><strong>请求体</strong>：</p>
<div class="codehilite"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;messages&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="p">{</span><span class="nt">&quot;role&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;system&quot;</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;content&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;You are a helpful assistant.&quot;</span><span class="p">},</span>
<span class="w">    </span><span class="p">{</span><span class="nt">&quot;role&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;user&quot;</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;content&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Hello!&quot;</span><span class="p">}</span>
<span class="w">  </span><span class="p">],</span>
<span class="w">  </span><span class="nt">&quot;generation&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;max_new_tokens&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">512</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;temperature&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">0.7</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;top_p&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">0.8</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nt">&quot;tts&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;enabled&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;mode&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;audio_assistant&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;ref_audio_path&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;assets/ref_audio/ref_minicpm_signature.wav&quot;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>多模态消息</strong>：</p>
<div class="codehilite"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;messages&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;role&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;user&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;content&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">        </span><span class="p">{</span><span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;text&quot;</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;text&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;描述这张图片&quot;</span><span class="p">},</span>
<span class="w">        </span><span class="p">{</span><span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;image&quot;</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;data&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;&lt;base64&gt;&quot;</span><span class="p">},</span>
<span class="w">        </span><span class="p">{</span><span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;audio&quot;</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;data&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;&lt;base64 PCM float32&gt;&quot;</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;sample_rate&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">16000</span><span class="p">}</span>
<span class="w">      </span><span class="p">]</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">]</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>响应</strong>：</p>
<div class="codehilite"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;text&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;你好！有什么可以帮你的？&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;audio_data&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;&lt;base64&gt;&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;audio_sample_rate&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">24000</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;tokens_generated&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">15</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;duration_ms&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">234.5</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;token_stats&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;cached_tokens&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;input_tokens&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">42</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;generated_tokens&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">15</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;total_tokens&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">57</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nt">&quot;recording_session_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;chat_abc123&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;success&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;error&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span>
<span class="p">}</span>
</code></pre></div>

<h4 id="post-apistreamingstop">POST /api/streaming/stop</h4>
<p>停止正在进行的 Streaming 生成。</p>
<p><strong>请求体</strong>：</p>
<div class="codehilite"><pre><span></span><code><span class="p">{</span><span class="nt">&quot;session_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;stream_abc123&quot;</span><span class="p">}</span>
</code></pre></div>

<hr />
<h3 id="_2">配置与预设</h3>
<h4 id="get-apifrontend_defaults">GET /api/frontend_defaults</h4>
<p>获取前端默认配置。</p>
<p><strong>响应</strong>：</p>
<div class="codehilite"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;playback_delay_ms&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">200</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;chat_vocoder&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;token2wav&quot;</span>
<span class="p">}</span>
</code></pre></div>

<h4 id="get-apipresets">GET /api/presets</h4>
<p>获取 System Prompt 预设列表。</p>
<p><strong>响应</strong>：</p>
<div class="codehilite"><pre><span></span><code><span class="p">[</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;default_en&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;English Assistant&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;system_prompt&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;You are a helpful assistant.&quot;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">]</span>
</code></pre></div>

<hr />
<h3 id="_3">参考音频管理</h3>
<h4 id="get-apidefault_ref_audio">GET /api/default_ref_audio</h4>
<p>获取默认参考音频信息。</p>
<h4 id="get-apiassetsref_audio">GET /api/assets/ref_audio</h4>
<p>列出所有参考音频。</p>
<p><strong>响应</strong>：</p>
<div class="codehilite"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;audios&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;ref_001&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Default Voice&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;source&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;builtin&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;file_path&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;assets/ref_audio/ref_minicpm_signature.wav&quot;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">]</span>
<span class="p">}</span>
</code></pre></div>

<h4 id="post-apiassetsref_audioexternal">POST /api/assets/ref_audio/external</h4>
<p>上传参考音频。上传时自动归一化为 16kHz 单声道 16-bit WAV。</p>
<p><strong>请求体</strong>：</p>
<div class="codehilite"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;My Voice&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;audio_data&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;&lt;base64 audio&gt;&quot;</span>
<span class="p">}</span>
</code></pre></div>

<h4 id="delete-apiassetsref_audioaudio_id">DELETE /api/assets/ref_audio/{audio_id}</h4>
<p>删除指定参考音频。</p>
<hr />
<h3 id="_4">队列管理</h3>
<h4 id="get-apiqueue">GET /api/queue</h4>
<p>获取队列状态快照。</p>
<p><strong>响应</strong>：</p>
<div class="codehilite"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;queue_length&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;entries&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;ticket_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;tk_001&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;position&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;task_type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;streaming&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;eta_seconds&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">15.0</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">],</span>
<span class="w">  </span><span class="nt">&quot;running&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;worker_url&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;http://localhost:22400&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;task_type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;streaming&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;session_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;stream_xyz&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;started_at&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;2026-02-24T10:30:00Z&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;elapsed_s&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">5.2</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">]</span>
<span class="p">}</span>
</code></pre></div>

<h4 id="get-apiqueueticket_id">GET /api/queue/{ticket_id}</h4>
<p>查询指定排队凭证状态。</p>
<h4 id="delete-apiqueueticket_id">DELETE /api/queue/{ticket_id}</h4>
<p>取消排队。</p>
<hr />
<h3 id="eta">ETA 配置</h3>
<h4 id="get-apiconfigeta">GET /api/config/eta</h4>
<p>获取 ETA 配置。</p>
<p><strong>响应</strong>：</p>
<div class="codehilite"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;eta_chat_s&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">15.0</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;eta_streaming_s&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">20.0</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;eta_audio_duplex_s&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">120.0</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;eta_omni_duplex_s&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">90.0</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;eta_ema_alpha&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">0.3</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;eta_ema_min_samples&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">3</span>
<span class="p">}</span>
</code></pre></div>

<h4 id="put-apiconfigeta">PUT /api/config/eta</h4>
<p>更新 ETA 配置。</p>
<hr />
<h3 id="kv-cache">KV Cache</h3>
<h4 id="get-apicache">GET /api/cache</h4>
<p>查询所有 Worker 的 KV Cache 状态。</p>
<hr />
<h3 id="_5">会话管理</h3>
<h4 id="get-apisessionssession_id">GET /api/sessions/{session_id}</h4>
<p>获取会话元数据。</p>
<p><strong>响应</strong>：</p>
<div class="codehilite"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;session_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;omni_abc123&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;omni_duplex&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;created_at&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;2026-02-24T10:00:00Z&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;config&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{}</span>
<span class="p">}</span>
</code></pre></div>

<h4 id="get-apisessionssession_idrecording">GET /api/sessions/{session_id}/recording</h4>
<p>获取会话录制时间线数据。</p>
<h4 id="get-apisessionssession_idassetsrelative_path">GET /api/sessions/{session_id}/assets/{relative_path}</h4>
<p>获取会话资源文件（音频/视频 chunk 等）。</p>
<h4 id="get-apisessionssession_iddownload">GET /api/sessions/{session_id}/download</h4>
<p>打包下载整个会话。</p>
<h4 id="post-apisessionssession_idupload-recording">POST /api/sessions/{session_id}/upload-recording</h4>
<p>上传前端录制的音频/视频文件。大小限制 200MB。</p>
<hr />
<h3 id="_6">应用管理</h3>
<h4 id="get-apiapps">GET /api/apps</h4>
<p>获取已启用的应用列表（前端用）。</p>
<h4 id="get-apiadminapps">GET /api/admin/apps</h4>
<p>获取所有应用列表（含启用状态，Admin 用）。</p>
<h4 id="put-apiadminapps">PUT /api/admin/apps</h4>
<p>切换应用启用状态。</p>
<p><strong>请求体</strong>：</p>
<div class="codehilite"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;app_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;omni&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;enabled&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span>
<span class="p">}</span>
</code></pre></div>

<hr />
<h2 id="websocket">WebSocket 协议</h2>
<h3 id="streaming">Streaming 协议</h3>
<p><strong>连接</strong>：<code>wss://localhost:8006/ws/streaming/{session_id}</code></p>
<h4 id="_7">客户端 → 服务端</h4>
<table>
<thead>
<tr>
<th>消息类型</th>
<th>字段</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>prefill</code></td>
<td><code>messages</code>, <code>generation</code>, <code>streaming</code>, <code>use_tts_template</code>, <code>enable_thinking</code></td>
<td>预填充，发送消息历史</td>
</tr>
<tr>
<td><code>generate</code></td>
<td>—</td>
<td>开始流式生成</td>
</tr>
<tr>
<td><code>stop</code></td>
<td>—</td>
<td>停止生成</td>
</tr>
</tbody>
</table>
<p><strong>prefill 示例</strong>：</p>
<div class="codehilite"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;prefill&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;messages&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="p">{</span><span class="nt">&quot;role&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;system&quot;</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;content&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;You are a helpful assistant.&quot;</span><span class="p">},</span>
<span class="w">    </span><span class="p">{</span><span class="nt">&quot;role&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;user&quot;</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;content&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Hello!&quot;</span><span class="p">}</span>
<span class="w">  </span><span class="p">],</span>
<span class="w">  </span><span class="nt">&quot;generation&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="nt">&quot;max_new_tokens&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">512</span><span class="p">},</span>
<span class="w">  </span><span class="nt">&quot;streaming&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;generate_audio&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;ref_audio_path&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;assets/ref_audio/ref_minicpm_signature.wav&quot;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h4 id="_8">服务端 → 客户端</h4>
<table>
<thead>
<tr>
<th>消息类型</th>
<th>字段</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>queued</code></td>
<td><code>ticket_id</code>, <code>position</code>, <code>eta_seconds</code></td>
<td>排入队列</td>
</tr>
<tr>
<td><code>queue_update</code></td>
<td><code>position</code>, <code>eta_seconds</code></td>
<td>队列位置更新</td>
</tr>
<tr>
<td><code>queue_done</code></td>
<td>—</td>
<td>离开队列，开始处理</td>
</tr>
<tr>
<td><code>prefill_done</code></td>
<td><code>prompt</code></td>
<td>预填充完成</td>
</tr>
<tr>
<td><code>chunk</code></td>
<td><code>chunk_index</code>, <code>text_delta</code>, <code>audio_data</code>, <code>is_final</code></td>
<td>流式输出 chunk</td>
</tr>
<tr>
<td><code>done</code></td>
<td><code>full_text</code>, <code>total_chunks</code>, <code>total_duration_ms</code></td>
<td>生成完成</td>
</tr>
<tr>
<td><code>error</code></td>
<td><code>message</code></td>
<td>错误</td>
</tr>
</tbody>
</table>
<hr />
<h3 id="duplex">Duplex 协议</h3>
<p><strong>连接</strong>：<code>wss://localhost:8006/ws/duplex/{session_id}</code></p>
<h4 id="_9">客户端 → 服务端</h4>
<table>
<thead>
<tr>
<th>消息类型</th>
<th>字段</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>prepare</code></td>
<td><code>system_prompt</code>, <code>config</code>, <code>ref_audio_path</code></td>
<td>初始化会话</td>
</tr>
<tr>
<td><code>audio_chunk</code></td>
<td><code>audio</code> (Base64 PCM float32)</td>
<td>发送音频块</td>
</tr>
<tr>
<td><code>video_frame</code></td>
<td><code>frame</code> (Base64 JPEG)</td>
<td>发送视频帧（仅 Omni）</td>
</tr>
<tr>
<td><code>pause</code></td>
<td>—</td>
<td>暂停会话</td>
</tr>
<tr>
<td><code>resume</code></td>
<td>—</td>
<td>恢复会话</td>
</tr>
<tr>
<td><code>stop</code></td>
<td>—</td>
<td>停止会话</td>
</tr>
<tr>
<td><code>client_diagnostic</code></td>
<td><code>metrics</code></td>
<td>客户端诊断信息</td>
</tr>
</tbody>
</table>
<p><strong>prepare 示例</strong>：</p>
<div class="codehilite"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;prepare&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;prefix_system_prompt&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;你是一个有趣的助手。&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;config&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;generate_audio&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;chunk_ms&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1000</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;temperature&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">0.7</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;force_listen_count&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">3</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nt">&quot;ref_audio_path&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;assets/ref_audio/ref_minicpm_signature.wav&quot;</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>audio_chunk 示例</strong>：</p>
<div class="codehilite"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;audio_chunk&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;audio&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;&lt;base64 PCM float32, 16kHz, 1s&gt;&quot;</span>
<span class="p">}</span>
</code></pre></div>

<h4 id="_10">服务端 → 客户端</h4>
<table>
<thead>
<tr>
<th>消息类型</th>
<th>字段</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>queued</code></td>
<td><code>ticket_id</code>, <code>position</code>, <code>eta_seconds</code></td>
<td>排入队列</td>
</tr>
<tr>
<td><code>queue_update</code></td>
<td><code>position</code>, <code>eta_seconds</code></td>
<td>队列位置更新</td>
</tr>
<tr>
<td><code>queue_done</code></td>
<td>—</td>
<td>离开队列</td>
</tr>
<tr>
<td><code>prepared</code></td>
<td>—</td>
<td>准备完成</td>
</tr>
<tr>
<td><code>result</code></td>
<td><code>is_listen</code>, <code>text</code>, <code>audio_data</code>, <code>end_of_turn</code>, <code>cost_all_ms</code></td>
<td>单步结果</td>
</tr>
<tr>
<td><code>paused</code></td>
<td>—</td>
<td>已暂停</td>
</tr>
<tr>
<td><code>resumed</code></td>
<td>—</td>
<td>已恢复</td>
</tr>
<tr>
<td><code>stopped</code></td>
<td><code>session_id</code></td>
<td>已停止</td>
</tr>
<tr>
<td><code>timeout</code></td>
<td>—</td>
<td>暂停超时</td>
</tr>
<tr>
<td><code>error</code></td>
<td><code>message</code></td>
<td>错误</td>
</tr>
</tbody>
</table>
<p><strong>result 示例</strong>：</p>
<div class="codehilite"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;result&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;is_listen&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;text&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;你好&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;audio_data&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;&lt;base64, 24kHz&gt;&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;end_of_turn&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;current_time&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">5000</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;cost_llm_ms&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">45.2</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;cost_tts_ms&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">12.3</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;cost_all_ms&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">78.5</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;n_tokens&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;server_send_ts&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">1708771200.123</span>
<span class="p">}</span>
</code></pre></div>

<hr />
<h2 id="_11">音频格式规范</h2>
<table>
<thead>
<tr>
<th>方向</th>
<th>格式</th>
<th>采样率</th>
<th>编码</th>
</tr>
</thead>
<tbody>
<tr>
<td>客户端 → 服务端</td>
<td>PCM Float32</td>
<td>16000 Hz</td>
<td>Base64</td>
</tr>
<tr>
<td>服务端 → 客户端</td>
<td>PCM Float32</td>
<td>24000 Hz</td>
<td>Base64</td>
</tr>
</tbody>
</table>
<ul>
<li>输入音频必须为 <strong>16kHz 单声道</strong></li>
<li>输出音频为 <strong>24kHz 单声道</strong></li>
<li>Base64 编码的是 Float32 数组的原始字节</li>
</ul></article>
  <footer><p>MiniCPM-o 4.5 PyTorch Simple Demo &mdash; 由 build_docs.py 自动生成</p></footer>
</main>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/python.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/bash.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/json.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/javascript.min.js"></script>
<script type="module">
import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.esm.min.mjs';
mermaid.initialize({startOnLoad:true,theme:'default',securityLevel:'loose'});
</script>
<script>
hljs.highlightAll();
function toggleSidebar(){document.getElementById('sidebar').classList.toggle('open');document.getElementById('content').classList.toggle('shifted');}
document.querySelectorAll('.nav-group-header').forEach(function(h){h.addEventListener('click',function(){this.parentElement.classList.toggle('collapsed');});});
document.addEventListener('click',function(e){var s=document.getElementById('sidebar'),t=document.querySelector('.sidebar-toggle');if(window.innerWidth<=768&&s.classList.contains('open')&&!s.contains(e.target)&&!t.contains(e.target)){s.classList.remove('open');document.getElementById('content').classList.remove('shifted');}});
</script>
</body>
</html>
