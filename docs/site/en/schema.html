<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Schema - MiniCPM-o 4.5 Docs</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">
<style>
* { margin:0; padding:0; box-sizing:border-box; }
:root {
  --sidebar-w: 260px;
  --bg: #fff; --bg-side: #f8f9fa; --bg-code: #f6f8fa;
  --c1: #24292f; --c2: #57606a;
  --border: #d0d7de; --accent: #0969da; --nav-active: #ddf4ff;
}
body { font-family: -apple-system,BlinkMacSystemFont,"Segoe UI","Noto Sans",Helvetica,Arial,sans-serif; color:var(--c1); line-height:1.6; background:var(--bg); }
.sidebar-toggle { position:fixed; top:12px; left:12px; z-index:1001; background:var(--bg-side); border:1px solid var(--border); border-radius:6px; padding:6px 10px; font-size:18px; cursor:pointer; display:none; }
.sidebar { position:fixed; top:0; left:0; width:var(--sidebar-w); height:100vh; overflow-y:auto; background:var(--bg-side); border-right:1px solid var(--border); padding:20px 0; z-index:1000; transition:transform .3s; }
.sidebar-header { padding:0 20px 16px; border-bottom:1px solid var(--border); margin-bottom:8px; }
.sidebar-header h2 { font-size:16px; font-weight:600; }
.sidebar-subtitle { font-size:12px; color:var(--c2); }
.lang-switch { display:inline-block; margin-top:6px; font-size:12px; color:var(--accent); text-decoration:none; padding:2px 8px; border:1px solid var(--border); border-radius:4px; transition:background .15s; }
.lang-switch:hover { background:var(--nav-active); text-decoration:none; }

.nav-list { list-style:none; padding:0 8px; }
.nav-list > li > a { display:block; padding:7px 12px; color:var(--c2); text-decoration:none; font-size:14px; border-radius:6px; transition:background .15s,color .15s; }
.nav-list > li > a:hover { background:#e8e8e8; color:var(--c1); }
.nav-list > li > a.active { background:var(--nav-active); color:var(--accent); font-weight:600; }

.nav-group { margin-top:4px; }
.nav-group-header { display:flex; align-items:center; gap:6px; padding:8px 12px; color:var(--c1); font-size:12px; font-weight:700; text-transform:uppercase; letter-spacing:.04em; cursor:pointer; border-radius:6px; user-select:none; transition:background .15s; }
.nav-group-header:hover { background:#eaeef2; }
.nav-group-header::before { content:""; display:inline-block; width:0; height:0; border-left:5px solid var(--c2); border-top:3.5px solid transparent; border-bottom:3.5px solid transparent; transition:transform .2s; transform:rotate(90deg); flex-shrink:0; }
.nav-group.collapsed .nav-group-header::before { transform:rotate(0); }
.nav-group-children { list-style:none; margin:0 0 4px 19px; padding:3px 0 3px 13px; border-left:2px solid #e1e4e8; overflow:hidden; max-height:500px; transition:max-height .25s ease,opacity .2s ease,padding .2s ease; opacity:1; }
.nav-group.collapsed .nav-group-children { max-height:0; opacity:0; padding:0 0 0 13px; }
.nav-group-children li a { display:block; padding:4px 10px; font-size:13px; color:var(--c2); text-decoration:none; border-radius:4px; transition:background .15s,color .15s; }
.nav-group-children li a:hover { background:#e8e8e8; color:var(--c1); }
.nav-group-children li a.active { background:var(--nav-active); color:var(--accent); font-weight:600; }

.content { margin-left:var(--sidebar-w); max-width:900px; padding:40px 48px; }
article h1 { font-size:28px; font-weight:600; padding-bottom:10px; border-bottom:1px solid var(--border); margin-bottom:20px; }
article h2 { font-size:22px; font-weight:600; margin-top:32px; margin-bottom:12px; padding-bottom:6px; border-bottom:1px solid #eaecef; }
article h3 { font-size:18px; font-weight:600; margin-top:24px; margin-bottom:10px; }
article h4 { font-size:15px; font-weight:600; margin-top:20px; margin-bottom:8px; }
article p { margin-bottom:14px; }
article ul,article ol { margin-bottom:14px; padding-left:24px; }
article li { margin-bottom:4px; }
article a { color:var(--accent); text-decoration:none; }
article a:hover { text-decoration:underline; }
article code { background:var(--bg-code); padding:2px 6px; border-radius:4px; font-size:13px; font-family:"SFMono-Regular",Consolas,"Liberation Mono",Menlo,monospace; }
article pre { background:var(--bg-code); border:1px solid var(--border); border-radius:6px; padding:16px; overflow-x:auto; margin-bottom:16px; line-height:1.5; }
article pre code { background:none; padding:0; font-size:13px; }
article table { width:100%; border-collapse:collapse; margin-bottom:16px; font-size:14px; }
article th,article td { border:1px solid var(--border); padding:8px 12px; text-align:left; }
article th { background:var(--bg-code); font-weight:600; }
article tr:nth-child(even) { background:#f8f9fa; }
article hr { border:none; border-top:1px solid var(--border); margin:28px 0; }
article blockquote { border-left:4px solid var(--accent); padding:8px 16px; margin:0 0 16px; color:var(--c2); background:#f8f9fa; border-radius:0 6px 6px 0; }
article .mermaid { text-align:center; margin:20px 0; }
footer { margin-top:60px; padding-top:16px; border-top:1px solid var(--border); color:var(--c2); font-size:13px; }
@media(max-width:768px) {
  .sidebar { transform:translateX(-100%); }
  .sidebar.open { transform:translateX(0); box-shadow:2px 0 8px rgba(0,0,0,.15); }
  .sidebar-toggle { display:block; }
  .content { margin-left:0; padding:50px 20px 40px; }
  .content.shifted { margin-left:var(--sidebar-w); }
}
</style>
</head>
<body>
<button class="sidebar-toggle" onclick="toggleSidebar()" aria-label="Toggle sidebar">&#9776;</button>
<nav class="sidebar" id="sidebar">
  <div class="sidebar-header">
    <h2>MiniCPM-o 4.5</h2>
    <span class="sidebar-subtitle">Documentation</span>
    <a href="../zh/schema.html" class="lang-switch">中文</a>
  </div>
  <ul class="nav-list">
    <li><a href="index.html">Overview</a></li>
    <li class="nav-group">
      <span class="nav-group-header">Architecture</span>
      <ul class="nav-group-children">
        <li><a href="architecture/index.html">Overview</a></li>
        <li><a href="architecture/streaming.html">Chat Mode</a></li>
        <li><a href="architecture/duplex.html">Duplex Mode</a></li>
        <li><a href="architecture/internals.html">Internals</a></li>
      </ul>
    </li>
    <li><a href="gateway.html">Gateway</a></li>
    <li><a href="worker.html">Worker</a></li>
    <li><a href="schema.html" class="active">Schema</a></li>
    <li><a href="model.html">Model</a></li>
    <li><a href="compile.html">torch.compile</a></li>
    <li class="nav-group">
      <span class="nav-group-header">Frontend</span>
      <ul class="nav-group-children">
        <li><a href="frontend/index.html">Overview</a></li>
        <li><a href="frontend/pages.html">Pages & Routes</a></li>
        <li><a href="frontend/audio.html">Audio</a></li>
        <li><a href="frontend/duplex-session.html">Duplex Session</a></li>
        <li><a href="frontend/components.html">UI Components</a></li>
      </ul>
    </li>
    <li><a href="api.html">API Reference</a></li>
    <li><a href="deployment.html">Deployment</a></li>
  </ul>
</nav>
<main class="content" id="content">
  <article><h1 id="schemas-processors">Schemas &amp; Processors</h1>
<p>This module defines the system's data models (Pydantic Schemas), unified processor abstractions, and the capability declaration system. It serves as the bridge between the Worker service layer and the underlying model.</p>
<h2 id="module-structure">Module Structure</h2>
<div class="codehilite"><pre><span></span><code><span class="nx">core</span><span class="o">/</span>
<span class="err">├──</span><span class="w"> </span><span class="nx">__init__</span><span class="p">.</span><span class="nx">py</span><span class="w">              </span><span class="err">#</span><span class="w"> </span><span class="nx">Module</span><span class="w"> </span><span class="nx">entry</span><span class="w"> </span><span class="nx">point</span><span class="p">,</span><span class="w"> </span><span class="nx">unified</span><span class="w"> </span><span class="nx">exports</span>
<span class="err">├──</span><span class="w"> </span><span class="nx">capabilities</span><span class="p">.</span><span class="nx">py</span><span class="w">          </span><span class="err">#</span><span class="w"> </span><span class="nx">Capability</span><span class="w"> </span><span class="nx">declaration</span><span class="w"> </span><span class="nx">system</span>
<span class="err">├──</span><span class="w"> </span><span class="nx">factory</span><span class="p">.</span><span class="nx">py</span><span class="w">               </span><span class="err">#</span><span class="w"> </span><span class="nx">Factory</span><span class="w"> </span><span class="nx">pattern</span>
<span class="err">├──</span><span class="w"> </span><span class="nx">internal</span><span class="o">/</span>
<span class="err">│</span><span class="w">   </span><span class="err">└──</span><span class="w"> </span><span class="nx">__init__</span><span class="p">.</span><span class="nx">py</span><span class="w">          </span><span class="err">#</span><span class="w"> </span><span class="nx">Internal</span><span class="w"> </span><span class="nx">implementation</span><span class="w"> </span><span class="p">(</span><span class="nx">reserved</span><span class="p">)</span>
<span class="err">├──</span><span class="w"> </span><span class="nx">modes</span><span class="o">/</span>
<span class="err">│</span><span class="w">   </span><span class="err">└──</span><span class="w"> </span><span class="nx">__init__</span><span class="p">.</span><span class="nx">py</span><span class="w">          </span><span class="err">#</span><span class="w"> </span><span class="nx">Inference</span><span class="w"> </span><span class="nx">modes</span><span class="w"> </span><span class="p">(</span><span class="nx">reserved</span><span class="p">)</span>
<span class="err">├──</span><span class="w"> </span><span class="nx">schemas</span><span class="o">/</span>
<span class="err">│</span><span class="w">   </span><span class="err">├──</span><span class="w"> </span><span class="nx">__init__</span><span class="p">.</span><span class="nx">py</span><span class="w">          </span><span class="err">#</span><span class="w"> </span><span class="nx">Schema</span><span class="w"> </span><span class="nx">exports</span>
<span class="err">│</span><span class="w">   </span><span class="err">├──</span><span class="w"> </span><span class="nx">common</span><span class="p">.</span><span class="nx">py</span><span class="w">            </span><span class="err">#</span><span class="w"> </span><span class="nx">Common</span><span class="w"> </span><span class="k">type</span><span class="w"> </span><span class="nx">definitions</span>
<span class="err">│</span><span class="w">   </span><span class="err">├──</span><span class="w"> </span><span class="nx">streaming</span><span class="p">.</span><span class="nx">py</span><span class="w">         </span><span class="err">#</span><span class="w"> </span><span class="nx">Streaming</span><span class="w"> </span><span class="nx">request</span><span class="o">/</span><span class="nx">response</span>
<span class="err">│</span><span class="w">   </span><span class="err">└──</span><span class="w"> </span><span class="nx">duplex</span><span class="p">.</span><span class="nx">py</span><span class="w">            </span><span class="err">#</span><span class="w"> </span><span class="nx">Duplex</span><span class="w"> </span><span class="nx">request</span><span class="o">/</span><span class="nx">response</span>
<span class="err">└──</span><span class="w"> </span><span class="nx">processors</span><span class="o">/</span>
<span class="w">    </span><span class="err">├──</span><span class="w"> </span><span class="nx">__init__</span><span class="p">.</span><span class="nx">py</span><span class="w">           </span><span class="err">#</span><span class="w"> </span><span class="nx">Processor</span><span class="w"> </span><span class="nx">exports</span>
<span class="w">    </span><span class="err">├──</span><span class="w"> </span><span class="kd">base</span><span class="p">.</span><span class="nx">py</span><span class="w">               </span><span class="err">#</span><span class="w"> </span><span class="nx">Base</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="nx">Mixin</span>
<span class="w">    </span><span class="err">└──</span><span class="w"> </span><span class="nx">unified</span><span class="p">.</span><span class="nx">py</span><span class="w">            </span><span class="err">#</span><span class="w"> </span><span class="nx">Unified</span><span class="w"> </span><span class="nx">processor</span><span class="w"> </span><span class="nx">implementation</span>
</code></pre></div>

<hr />
<h2 id="schemas-pydantic-data-models">schemas/ — Pydantic Data Models</h2>
<h3 id="commonpy-common-types">common.py — Common Types</h3>
<h4 id="enumerations">Enumerations</h4>
<table>
<thead>
<tr>
<th>Enum</th>
<th>Values</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>Role</code></td>
<td><code>system</code>, <code>user</code>, <code>assistant</code></td>
<td>Message role</td>
</tr>
<tr>
<td><code>TTSMode</code></td>
<td><code>default</code>, <code>audio_assistant</code>, <code>omni</code>, <code>audio_roleplay</code>, <code>voice_cloning</code></td>
<td>TTS mode</td>
</tr>
<tr>
<td><code>ContentType</code></td>
<td><code>text</code>, <code>image</code>, <code>audio</code>, <code>video</code></td>
<td>Content type</td>
</tr>
</tbody>
</table>
<h4 id="content-models">Content Models</h4>
<table>
<thead>
<tr>
<th>Model</th>
<th>Key Fields</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>TextContent</code></td>
<td><code>type="text"</code>, <code>text: str</code></td>
<td>Text content</td>
</tr>
<tr>
<td><code>ImageContent</code></td>
<td><code>type="image"</code>, <code>data: str</code></td>
<td>Image content (Base64)</td>
</tr>
<tr>
<td><code>AudioContent</code></td>
<td><code>type="audio"</code>, <code>data: str</code>, <code>sample_rate: int = 16000</code></td>
<td>Audio content (Base64 PCM float32)</td>
</tr>
<tr>
<td><code>VideoContent</code></td>
<td><code>type="video"</code>, <code>data: str</code>, <code>stack_frames: int = 1</code></td>
<td>Video content (Base64 video file, auto-extracts frames and audio)</td>
</tr>
</tbody>
</table>
<p>Type alias: <code>ContentItem = Union[TextContent, ImageContent, AudioContent, VideoContent]</code></p>
<h4 id="message-model">Message Model</h4>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">Message</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">role</span><span class="p">:</span> <span class="n">Role</span>
    <span class="n">content</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">ContentItem</span><span class="p">]]</span>
</code></pre></div>

<p><code>content</code> supports either a plain text string or a multimodal content list.</p>
<h4 id="configuration-models">Configuration Models</h4>
<table>
<thead>
<tr>
<th>Model</th>
<th>Key Fields</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>TTSSamplingParams</code></td>
<td><code>top_p=0.85</code>, <code>temperature=0.8</code>, <code>repetition_penalty=1.05</code></td>
<td>TTS sampling parameters</td>
</tr>
<tr>
<td><code>TTSConfig</code></td>
<td><code>enabled</code>, <code>mode</code>, <code>ref_audio_path</code>, <code>ref_audio_data</code>, <code>language</code></td>
<td>TTS configuration</td>
</tr>
<tr>
<td><code>ImageConfig</code></td>
<td><code>max_slice_nums</code>, <code>use_image_id</code></td>
<td>Image processing configuration</td>
</tr>
<tr>
<td><code>GenerationConfig</code></td>
<td><code>max_new_tokens=512</code>, <code>temperature=0.7</code>, <code>top_p=0.8</code></td>
<td>Generation configuration</td>
</tr>
</tbody>
</table>
<h3 id="streamingpy-streaming-schema">streaming.py — Streaming Schema</h3>
<p>Data structures for streaming generation (<code>StreamingChunk</code>, etc.), reused by ChatView's <code>streaming_generate()</code>.</p>
<h3 id="duplexpy-duplex-mode-schema">duplex.py — Duplex Mode Schema</h3>
<h4 id="duplexconfig">DuplexConfig</h4>
<table>
<thead>
<tr>
<th>Field</th>
<th>Default</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>generate_audio</code></td>
<td><code>True</code></td>
<td>Generate audio</td>
</tr>
<tr>
<td><code>ls_mode</code></td>
<td><code>"explicit"</code></td>
<td>Listen/Speak mode</td>
</tr>
<tr>
<td><code>force_listen_count</code></td>
<td><code>3</code></td>
<td>Startup protection period (force listen for first N steps)</td>
</tr>
<tr>
<td><code>max_new_speak_tokens_per_chunk</code></td>
<td><code>20</code></td>
<td>Maximum speak tokens per chunk</td>
</tr>
<tr>
<td><code>temperature</code></td>
<td><code>0.7</code></td>
<td>Generation temperature</td>
</tr>
<tr>
<td><code>top_k</code></td>
<td><code>20</code></td>
<td>Top-K sampling</td>
</tr>
<tr>
<td><code>top_p</code></td>
<td><code>0.8</code></td>
<td>Top-P sampling</td>
</tr>
<tr>
<td><code>listen_prob_scale</code></td>
<td><code>1.0</code></td>
<td>Listen probability scale</td>
</tr>
<tr>
<td><code>chunk_ms</code></td>
<td><code>1000</code></td>
<td>Audio chunk duration (milliseconds)</td>
</tr>
<tr>
<td><code>sample_rate</code></td>
<td><code>16000</code></td>
<td>Sample rate</td>
</tr>
</tbody>
</table>
<h4 id="duplexpreparerequest">DuplexPrepareRequest</h4>
<p>Initialize duplex session: <code>prefix_system_prompt</code>, <code>suffix_system_prompt</code>, <code>ref_audio_path</code>, <code>prompt_wav_path</code>.</p>
<h4 id="duplexprefillrequest">DuplexPrefillRequest</h4>
<p>Per-step prefill: <code>audio_waveform</code> (Base64), <code>audio_path</code>, <code>frame_list</code> (video frame list), <code>max_slice_nums</code>.</p>
<h4 id="duplexgenerateresult">DuplexGenerateResult</h4>
<p>Single-step generation result:</p>
<table>
<thead>
<tr>
<th>Field</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>is_listen</code></td>
<td>Whether in listening state</td>
</tr>
<tr>
<td><code>text</code></td>
<td>Generated text</td>
</tr>
<tr>
<td><code>audio_data</code></td>
<td>Base64 audio (24kHz)</td>
</tr>
<tr>
<td><code>end_of_turn</code></td>
<td>Whether the turn has ended</td>
</tr>
<tr>
<td><code>current_time</code></td>
<td>Current timestamp</td>
</tr>
<tr>
<td><code>cost_llm_ms</code></td>
<td>LLM inference latency</td>
</tr>
<tr>
<td><code>cost_tts_ms</code></td>
<td>TTS latency</td>
</tr>
<tr>
<td><code>cost_all_ms</code></td>
<td>Total latency</td>
</tr>
<tr>
<td><code>n_tokens</code></td>
<td>Number of generated LLM tokens</td>
</tr>
<tr>
<td><code>n_tts_tokens</code></td>
<td>Number of generated TTS tokens</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="processors-inference-processors">processors/ — Inference Processors</h2>
<h3 id="basepy-base-class">base.py — Base Class</h3>
<h4 id="baseprocessor-abstract-base-class">BaseProcessor (Abstract Base Class)</h4>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">BaseProcessor</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">device</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;cuda&quot;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="nd">@abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">mode</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ProcessorMode</span><span class="p">:</span> <span class="o">...</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">capabilities</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ProcessorCapabilities</span><span class="p">:</span> <span class="o">...</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_load_model</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span> <span class="o">...</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_release_resources</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span> <span class="o">...</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">is_ready</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span> <span class="o">...</span>
</code></pre></div>

<h4 id="minicpmoprocessormixin">MiniCPMOProcessorMixin</h4>
<p>A Mixin providing shared functionality for processors:</p>
<table>
<thead>
<tr>
<th>Method</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>_load_ref_audio(path, cache)</code></td>
<td>Load reference audio (with caching support)</td>
</tr>
<tr>
<td><code>_convert_content_to_model_format(content)</code></td>
<td>Convert Schema content to model format</td>
</tr>
<tr>
<td><code>_convert_messages_to_model_format(messages, tts_config)</code></td>
<td>Convert message list to model format</td>
</tr>
<tr>
<td><code>_resolve_ref_audio(tts_config)</code></td>
<td>Resolve reference audio (path or Base64)</td>
</tr>
<tr>
<td><code>_init_tts_mode(streaming)</code></td>
<td>Initialize TTS mode</td>
</tr>
</tbody>
</table>
<h3 id="unifiedpy-unified-processor">unified.py — Unified Processor</h3>
<h4 id="unifiedprocessor">UnifiedProcessor</h4>
<p>A unified processor that loads the model once and supports millisecond-level hot-switching between Streaming and Duplex modes.</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">UnifiedProcessor</span><span class="p">(</span><span class="n">BaseProcessor</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">model_path</span><span class="p">,</span> <span class="n">pt_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="s2">&quot;cuda&quot;</span><span class="p">,</span>
        <span class="n">ref_audio_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">duplex_config</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">preload_both_tts</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="nb">compile</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">attn_implementation</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span>
    <span class="p">)</span>
</code></pre></div>

<table>
<thead>
<tr>
<th>Method/Property</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>_load_model()</code></td>
<td>Load model and TTS</td>
</tr>
<tr>
<td><code>_release_resources()</code></td>
<td>Release all resources</td>
</tr>
<tr>
<td><code>set_streaming_mode()</code></td>
<td>Switch to Streaming mode, returns <code>StreamingView</code></td>
</tr>
<tr>
<td><code>set_duplex_mode()</code></td>
<td>Switch to Duplex mode, returns <code>DuplexView</code></td>
</tr>
<tr>
<td><code>streaming</code></td>
<td>StreamingView property</td>
</tr>
<tr>
<td><code>duplex</code></td>
<td>DuplexView property</td>
</tr>
<tr>
<td><code>kv_cache_length</code></td>
<td>Current KV Cache length</td>
</tr>
</tbody>
</table>
<h4 id="chatview">ChatView</h4>
<p>ChatView provides the dedicated API for Turn-based Chat, supporting both streaming and non-streaming generation modes.</p>
<table>
<thead>
<tr>
<th>Method/Property</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>prefill(session_id, msgs, ...)</code></td>
<td>Prefill all messages into KV Cache in one shot</td>
</tr>
<tr>
<td><code>generate(session_id, ...)</code></td>
<td>Non-streaming generation (HF generate + TTS)</td>
</tr>
<tr>
<td><code>streaming_generate(session_id, ...)</code></td>
<td>Streaming generation, returns <code>Generator[StreamingChunk]</code></td>
</tr>
<tr>
<td><code>kv_cache_length</code></td>
<td>Current KV Cache length</td>
</tr>
<tr>
<td><code>chat(request)</code></td>
<td>Legacy interface (combined prefill + generate)</td>
</tr>
</tbody>
</table>
<h4 id="duplexview">DuplexView</h4>
<table>
<thead>
<tr>
<th>Method</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>prepare(system_prompt_text, ref_audio_path, prompt_wav_path)</code></td>
<td>Prepare duplex session</td>
</tr>
<tr>
<td><code>prefill(audio_waveform, audio_path, frame_list, max_slice_nums)</code></td>
<td>Prefill audio/video</td>
</tr>
<tr>
<td><code>generate(force_listen)</code></td>
<td>Generate one step, returns <code>DuplexGenerateResult</code></td>
</tr>
<tr>
<td><code>finalize()</code></td>
<td>End current turn</td>
</tr>
<tr>
<td><code>set_break()</code> / <code>clear_break()</code></td>
<td>Set/clear interrupt flag</td>
</tr>
<tr>
<td><code>stop()</code></td>
<td>Stop session</td>
</tr>
<tr>
<td><code>is_break_set()</code> / <code>is_stopped()</code></td>
<td>Query status</td>
</tr>
<tr>
<td><code>cleanup()</code></td>
<td>Clean up resources, release GPU memory</td>
</tr>
<tr>
<td><code>offline_inference(task_input)</code></td>
<td>Offline inference</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="capabilitiespy-capability-declaration-system">capabilities.py — Capability Declaration System</h2>
<h3 id="processormode-enum">ProcessorMode Enum</h3>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">ProcessorMode</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
    <span class="n">STREAMING</span> <span class="o">=</span> <span class="s2">&quot;streaming&quot;</span>
    <span class="n">DUPLEX</span> <span class="o">=</span> <span class="s2">&quot;duplex&quot;</span>
</code></pre></div>

<h3 id="processorcapabilities-data-class">ProcessorCapabilities Data Class</h3>
<div class="codehilite"><pre><span></span><code><span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">ProcessorCapabilities</span><span class="p">:</span>
    <span class="n">mode</span><span class="p">:</span> <span class="n">ProcessorMode</span>
    <span class="c1"># Input capabilities</span>
    <span class="n">supports_text</span><span class="p">:</span> <span class="nb">bool</span>
    <span class="n">supports_image</span><span class="p">:</span> <span class="nb">bool</span>
    <span class="n">supports_audio</span><span class="p">:</span> <span class="nb">bool</span>
    <span class="n">supports_video</span><span class="p">:</span> <span class="nb">bool</span>
    <span class="c1"># Output capabilities</span>
    <span class="n">supports_text_output</span><span class="p">:</span> <span class="nb">bool</span>
    <span class="n">supports_audio_output</span><span class="p">:</span> <span class="nb">bool</span>
    <span class="n">supports_streaming_output</span><span class="p">:</span> <span class="nb">bool</span>
    <span class="c1"># Interaction capabilities</span>
    <span class="n">supports_multi_turn</span><span class="p">:</span> <span class="nb">bool</span>
    <span class="n">supports_interrupt</span><span class="p">:</span> <span class="nb">bool</span>
    <span class="n">supports_rollback</span><span class="p">:</span> <span class="nb">bool</span>
    <span class="c1"># Resource requirements</span>
    <span class="n">requires_exclusive_worker</span><span class="p">:</span> <span class="nb">bool</span>
    <span class="n">supports_kv_cache_reuse</span><span class="p">:</span> <span class="nb">bool</span>
</code></pre></div>

<h3 id="predefined-capability-constants">Predefined Capability Constants</h3>
<table>
<thead>
<tr>
<th>Capability</th>
<th>Streaming</th>
<th>Duplex</th>
</tr>
</thead>
<tbody>
<tr>
<td>Streaming output</td>
<td>Supported</td>
<td>Supported</td>
</tr>
<tr>
<td>Interrupt support</td>
<td>--</td>
<td>Supported</td>
</tr>
<tr>
<td>Rollback support</td>
<td>Supported</td>
<td>--</td>
</tr>
<tr>
<td>KV Cache reuse</td>
<td>Supported</td>
<td>Supported</td>
</tr>
<tr>
<td>Exclusive Worker</td>
<td>--</td>
<td>Required</td>
</tr>
<tr>
<td>Multi-turn dialogue</td>
<td>Supported</td>
<td>Supported</td>
</tr>
</tbody>
</table>
<h3 id="helper-functions">Helper Functions</h3>
<ul>
<li><code>get_capabilities(mode)</code> — Get capability declaration for a given mode</li>
<li><code>supports_feature(mode, feature)</code> — Check if a mode supports a specific feature</li>
</ul>
<hr />
<h2 id="factorypy-factory-pattern">factory.py — Factory Pattern</h2>
<h3 id="processorfactory">ProcessorFactory</h3>
<table>
<thead>
<tr>
<th>Method</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>get_processor(...)</code></td>
<td>Get or create a UnifiedProcessor (with caching)</td>
</tr>
<tr>
<td><code>create(mode, ...)</code></td>
<td>Create a View for the specified mode</td>
</tr>
<tr>
<td><code>from_config(config)</code></td>
<td>Create a View from a configuration dictionary</td>
</tr>
</tbody>
</table>
<p>Convenience function: <code>create_processor(mode, ...)</code> — Quickly create a View for the specified mode.</p></article>
  <footer><p>MiniCPM-o 4.5 PyTorch Simple Demo &mdash; Generated by build_docs.py</p></footer>
</main>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/python.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/bash.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/json.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/javascript.min.js"></script>
<script type="module">
import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.esm.min.mjs';
mermaid.initialize({startOnLoad:true,theme:'default',securityLevel:'loose'});
</script>
<script>
hljs.highlightAll();
function toggleSidebar(){document.getElementById('sidebar').classList.toggle('open');document.getElementById('content').classList.toggle('shifted');}
document.querySelectorAll('.nav-group-header').forEach(function(h){h.addEventListener('click',function(){this.parentElement.classList.toggle('collapsed');});});
document.addEventListener('click',function(e){var s=document.getElementById('sidebar'),t=document.querySelector('.sidebar-toggle');if(window.innerWidth<=768&&s.classList.contains('open')&&!s.contains(e.target)&&!t.contains(e.target)){s.classList.remove('open');document.getElementById('content').classList.remove('shifted');}});
</script>
</body>
</html>
