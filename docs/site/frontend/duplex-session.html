<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>双工会话 - MiniCPM-o 4.5 文档</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">
<style>
* { margin:0; padding:0; box-sizing:border-box; }
:root {
  --sidebar-w: 260px;
  --bg: #fff; --bg-side: #f8f9fa; --bg-code: #f6f8fa;
  --c1: #24292f; --c2: #57606a;
  --border: #d0d7de; --accent: #0969da; --nav-active: #ddf4ff;
}
body { font-family: -apple-system,BlinkMacSystemFont,"Segoe UI","Noto Sans",Helvetica,Arial,sans-serif; color:var(--c1); line-height:1.6; background:var(--bg); }
.sidebar-toggle { position:fixed; top:12px; left:12px; z-index:1001; background:var(--bg-side); border:1px solid var(--border); border-radius:6px; padding:6px 10px; font-size:18px; cursor:pointer; display:none; }
.sidebar { position:fixed; top:0; left:0; width:var(--sidebar-w); height:100vh; overflow-y:auto; background:var(--bg-side); border-right:1px solid var(--border); padding:20px 0; z-index:1000; transition:transform .3s; }
.sidebar-header { padding:0 20px 16px; border-bottom:1px solid var(--border); margin-bottom:8px; }
.sidebar-header h2 { font-size:16px; font-weight:600; }
.sidebar-subtitle { font-size:12px; color:var(--c2); }

.nav-list { list-style:none; padding:0 8px; }
.nav-list > li > a { display:block; padding:7px 12px; color:var(--c2); text-decoration:none; font-size:14px; border-radius:6px; transition:background .15s,color .15s; }
.nav-list > li > a:hover { background:#e8e8e8; color:var(--c1); }
.nav-list > li > a.active { background:var(--nav-active); color:var(--accent); font-weight:600; }

.nav-group { margin-top:4px; }
.nav-group-header { display:flex; align-items:center; gap:6px; padding:8px 12px; color:var(--c1); font-size:12px; font-weight:700; text-transform:uppercase; letter-spacing:.04em; cursor:pointer; border-radius:6px; user-select:none; transition:background .15s; }
.nav-group-header:hover { background:#eaeef2; }
.nav-group-header::before { content:""; display:inline-block; width:0; height:0; border-left:5px solid var(--c2); border-top:3.5px solid transparent; border-bottom:3.5px solid transparent; transition:transform .2s; transform:rotate(90deg); flex-shrink:0; }
.nav-group.collapsed .nav-group-header::before { transform:rotate(0); }
.nav-group-children { list-style:none; margin:0 0 4px 19px; padding:3px 0 3px 13px; border-left:2px solid #e1e4e8; overflow:hidden; max-height:500px; transition:max-height .25s ease,opacity .2s ease,padding .2s ease; opacity:1; }
.nav-group.collapsed .nav-group-children { max-height:0; opacity:0; padding:0 0 0 13px; }
.nav-group-children li a { display:block; padding:4px 10px; font-size:13px; color:var(--c2); text-decoration:none; border-radius:4px; transition:background .15s,color .15s; }
.nav-group-children li a:hover { background:#e8e8e8; color:var(--c1); }
.nav-group-children li a.active { background:var(--nav-active); color:var(--accent); font-weight:600; }

.content { margin-left:var(--sidebar-w); max-width:900px; padding:40px 48px; }
article h1 { font-size:28px; font-weight:600; padding-bottom:10px; border-bottom:1px solid var(--border); margin-bottom:20px; }
article h2 { font-size:22px; font-weight:600; margin-top:32px; margin-bottom:12px; padding-bottom:6px; border-bottom:1px solid #eaecef; }
article h3 { font-size:18px; font-weight:600; margin-top:24px; margin-bottom:10px; }
article h4 { font-size:15px; font-weight:600; margin-top:20px; margin-bottom:8px; }
article p { margin-bottom:14px; }
article ul,article ol { margin-bottom:14px; padding-left:24px; }
article li { margin-bottom:4px; }
article a { color:var(--accent); text-decoration:none; }
article a:hover { text-decoration:underline; }
article code { background:var(--bg-code); padding:2px 6px; border-radius:4px; font-size:13px; font-family:"SFMono-Regular",Consolas,"Liberation Mono",Menlo,monospace; }
article pre { background:var(--bg-code); border:1px solid var(--border); border-radius:6px; padding:16px; overflow-x:auto; margin-bottom:16px; line-height:1.5; }
article pre code { background:none; padding:0; font-size:13px; }
article table { width:100%; border-collapse:collapse; margin-bottom:16px; font-size:14px; }
article th,article td { border:1px solid var(--border); padding:8px 12px; text-align:left; }
article th { background:var(--bg-code); font-weight:600; }
article tr:nth-child(even) { background:#f8f9fa; }
article hr { border:none; border-top:1px solid var(--border); margin:28px 0; }
article blockquote { border-left:4px solid var(--accent); padding:8px 16px; margin:0 0 16px; color:var(--c2); background:#f8f9fa; border-radius:0 6px 6px 0; }
article .mermaid { text-align:center; margin:20px 0; }
footer { margin-top:60px; padding-top:16px; border-top:1px solid var(--border); color:var(--c2); font-size:13px; }
@media(max-width:768px) {
  .sidebar { transform:translateX(-100%); }
  .sidebar.open { transform:translateX(0); box-shadow:2px 0 8px rgba(0,0,0,.15); }
  .sidebar-toggle { display:block; }
  .content { margin-left:0; padding:50px 20px 40px; }
  .content.shifted { margin-left:var(--sidebar-w); }
}
</style>
</head>
<body>
<button class="sidebar-toggle" onclick="toggleSidebar()" aria-label="Toggle sidebar">&#9776;</button>
<nav class="sidebar" id="sidebar">
  <div class="sidebar-header">
    <h2>MiniCPM-o 4.5</h2>
    <span class="sidebar-subtitle">项目文档</span>
  </div>
  <ul class="nav-list">
    <li><a href="../index.html">项目概述</a></li>
    <li><a href="../architecture.html">系统架构</a></li>
    <li><a href="../gateway.html">Gateway 模块</a></li>
    <li><a href="../worker.html">Worker 模块</a></li>
    <li><a href="../core.html">Core 模块</a></li>
    <li><a href="../model.html">模型模块</a></li>
    <li><a href="../compile.html">torch.compile</a></li>
    <li class="nav-group">
      <span class="nav-group-header">前端模块</span>
      <ul class="nav-group-children">
        <li><a href="../frontend/index.html">前端概述</a></li>
        <li><a href="../frontend/pages.html">页面与路由</a></li>
        <li><a href="../frontend/audio.html">音频处理</a></li>
        <li><a href="../frontend/duplex-session.html" class="active">双工会话</a></li>
        <li><a href="../frontend/components.html">UI 组件</a></li>
      </ul>
    </li>
    <li><a href="../api.html">API 参考</a></li>
    <li><a href="../deployment.html">配置与部署</a></li>
  </ul>
</nav>
<main class="content" id="content">
  <article><h1 id="_1">双工会话管理</h1>
<h2 id="duplexsession">DuplexSession 类</h2>
<p><code>DuplexSession</code>（<code>duplex/lib/duplex-session.js</code>）是双工模式的核心会话管理类，封装 WebSocket 生命周期、消息协议、状态机和音频播放集成。</p>
<h3 id="_2">构造函数</h3>
<div class="codehilite"><pre><span></span><code><span class="ow">new</span><span class="w"> </span><span class="nx">DuplexSession</span><span class="p">({</span>
<span class="w">    </span><span class="nx">prefix</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;omni&#39;</span><span class="p">,</span><span class="w">              </span><span class="c1">// 会话 ID 前缀 (&#39;omni&#39; | &#39;adx&#39;)</span>
<span class="w">    </span><span class="nx">getMaxKvTokens</span><span class="o">:</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="mf">8192</span><span class="p">,</span><span class="w">  </span><span class="c1">// KV Cache 上限</span>
<span class="w">    </span><span class="nx">getPlaybackDelayMs</span><span class="o">:</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="mf">200</span><span class="p">,</span><span class="c1">// 播放延迟</span>
<span class="w">    </span><span class="nx">outputSampleRate</span><span class="o">:</span><span class="w"> </span><span class="mf">24000</span><span class="p">,</span><span class="w">     </span><span class="c1">// 音频输出采样率</span>
<span class="w">    </span><span class="nx">getWsUrl</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">sid</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="sb">`...`</span><span class="p">,</span><span class="w">    </span><span class="c1">// WebSocket URL 生成</span>
<span class="p">})</span>
</code></pre></div>

<h3 id="_3">完整方法列表</h3>
<table>
<thead>
<tr>
<th>方法</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>start(systemPrompt, preparePayload, startMediaFn)</code></td>
<td>启动会话：连接 WS → 排队 → prepare → 启动媒体采集</td>
</tr>
<tr>
<td><code>sendChunk(msg)</code></td>
<td>发送音频 chunk（自动注入 <code>force_listen</code> 标志）</td>
</tr>
<tr>
<td><code>pauseToggle()</code></td>
<td>切换暂停/恢复</td>
</tr>
<tr>
<td><code>toggleForceListen()</code></td>
<td>切换强制监听模式</td>
</tr>
<tr>
<td><code>stop()</code></td>
<td>停止会话</td>
</tr>
<tr>
<td><code>cancelQueue()</code></td>
<td>取消排队</td>
</tr>
<tr>
<td><code>cleanup()</code></td>
<td>完整清理（WS 关闭 + AudioPlayer 停止）</td>
</tr>
</tbody>
</table>
<h3 id="_4">回调钩子</h3>
<table>
<thead>
<tr>
<th>回调</th>
<th>参数</th>
<th>触发时机</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>onSystemLog(text)</code></td>
<td>日志文本</td>
<td>系统事件（连接/断开/错误）</td>
</tr>
<tr>
<td><code>onQueueUpdate(data)</code></td>
<td><code>{position, eta_seconds}</code></td>
<td>排队状态变化</td>
</tr>
<tr>
<td><code>onQueueDone()</code></td>
<td>—</td>
<td>离开队列，开始处理</td>
</tr>
<tr>
<td><code>onSpeakStart(text)</code></td>
<td>首段文本</td>
<td>AI 开始说话</td>
</tr>
<tr>
<td><code>onSpeakUpdate(handle, text)</code></td>
<td>累积文本</td>
<td>AI 说话文本更新</td>
</tr>
<tr>
<td><code>onSpeakEnd()</code></td>
<td>—</td>
<td>AI 说话结束</td>
</tr>
<tr>
<td><code>onListenResult(result)</code></td>
<td>完整 result</td>
<td>模型处于聆听状态</td>
</tr>
<tr>
<td><code>onExtraResult(result, recvTime)</code></td>
<td>原始结果</td>
<td>每个 result 都触发（用于指标）</td>
</tr>
<tr>
<td><code>onPrepared()</code></td>
<td>—</td>
<td>准备完成</td>
</tr>
<tr>
<td><code>onCleanup()</code></td>
<td>—</td>
<td>会话清理完成</td>
</tr>
<tr>
<td><code>onMetrics(data)</code></td>
<td>音频指标</td>
<td>AudioPlayer 指标更新</td>
</tr>
<tr>
<td><code>onRunningChange(running)</code></td>
<td>bool</td>
<td>运行状态变化</td>
</tr>
<tr>
<td><code>onPauseStateChange(state)</code></td>
<td>状态字符串</td>
<td>暂停状态变化</td>
</tr>
<tr>
<td><code>onForceListenChange(active)</code></td>
<td>bool</td>
<td>强制监听状态变化</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="_5">会话生命周期</h2>
<pre class="mermaid">
sequenceDiagram
    participant UI as 用户界面
    participant DS as DuplexSession
    participant WS as WebSocket
    participant AP as AudioPlayer
    participant Media as 媒体采集

    UI->>DS: start(systemPrompt, payload, startMediaFn)
    DS->>WS: connect(wsUrl)

    alt 排队
        WS-->>DS: queued
        DS->>UI: onQueueUpdate
        loop 等待
            WS-->>DS: queue_update
            DS->>UI: onQueueUpdate
        end
        WS-->>DS: queue_done
        DS->>UI: onQueueDone
    end

    DS->>WS: prepare (system_prompt + config)
    WS-->>DS: prepared
    DS->>UI: onPrepared
    DS->>Media: startMediaFn() 启动音频/视频采集

    loop 全双工循环
        Media->>DS: sendChunk(audio + frame)
        DS->>WS: audio_chunk
        WS-->>DS: result

        alt is_listen=false (SPEAK)
            DS->>AP: beginTurn() / playChunk() / endTurn()
            DS->>UI: onSpeakStart → onSpeakUpdate → onSpeakEnd
        else is_listen=true (LISTEN)
            DS->>UI: onListenResult
        end
    end

    UI->>DS: stop()
    DS->>WS: stop
    DS->>AP: stopAll()
    DS->>Media: 停止采集
    DS->>UI: onCleanup
</pre>

<hr />
<h2 id="_6">状态机</h2>
<h3 id="_7">暂停状态机</h3>
<pre class="mermaid">
stateDiagram-v2
    [*] --> active
    active --> pausing: pauseToggle()
    Note right of pausing: 发送 pause 消息\n等待服务器确认 + 音频播完
    pausing --> paused: serverPauseConfirmed\n&& 音频播放完成
    paused --> active: pauseToggle()\n发送 resume
    active --> [*]: stop()
    pausing --> [*]: stop()
    paused --> [*]: stop()
</pre>

<p><strong>pausing → paused 转换条件</strong>：
- 服务器返回 <code>paused</code> 确认消息（<code>serverPauseConfirmed = true</code>）
- AudioPlayer 当前没有正在播放的音频</p>
<p>两个条件都满足时 <code>_tryCompletePause()</code> 将状态推进到 <code>paused</code>。</p>
<h3 id="_8">强制监听模式</h3>
<p><code>forceListenActive</code> 标志在每个 <code>sendChunk()</code> 中注入到消息的 <code>force_listen</code> 字段。开启时：
- Worker 端 <code>duplex_generate(force_listen=True)</code> 强制模型输出 <code>&lt;|listen|&gt;</code>
- AudioPlayer 立即 <code>stopAll()</code> 停止当前播放
- 用于用户想打断 AI 说话的场景</p>
<h3 id="kv-cache">KV Cache 自动停止</h3>
<p>当 result 中的 <code>kv_cache_length &gt;= maxKvTokens</code> 时，DuplexSession 自动调用 <code>stop()</code>，防止 KV Cache 溢出。</p>
<hr />
<h2 id="websocket">WebSocket 消息协议</h2>
<h3 id="_9">客户端 → 服务端</h3>
<table>
<thead>
<tr>
<th>类型</th>
<th>字段</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>prepare</code></td>
<td><code>system_prompt</code>, <code>config</code>, <code>ref_audio_base64</code>, <code>tts_ref_audio_base64</code>, <code>max_slice_nums</code>, <code>deferred_finalize</code></td>
<td>初始化双工会话</td>
</tr>
<tr>
<td><code>audio_chunk</code></td>
<td><code>audio_base64</code>, <code>frame_base64_list</code>, <code>force_listen</code>, <code>max_slice_nums</code></td>
<td>发送音频 + 视频帧</td>
</tr>
<tr>
<td><code>pause</code></td>
<td><code>timeout</code></td>
<td>暂停请求</td>
</tr>
<tr>
<td><code>resume</code></td>
<td>—</td>
<td>恢复请求</td>
</tr>
<tr>
<td><code>stop</code></td>
<td>—</td>
<td>停止会话</td>
</tr>
<tr>
<td><code>client_diagnostic</code></td>
<td><code>metrics</code></td>
<td>客户端诊断信息</td>
</tr>
</tbody>
</table>
<h3 id="_10">服务端 → 客户端</h3>
<table>
<thead>
<tr>
<th>类型</th>
<th>字段</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>queued</code></td>
<td><code>ticket_id</code>, <code>position</code>, <code>eta_seconds</code></td>
<td>入队通知</td>
</tr>
<tr>
<td><code>queue_update</code></td>
<td><code>position</code>, <code>eta_seconds</code></td>
<td>位置更新</td>
</tr>
<tr>
<td><code>queue_done</code></td>
<td>—</td>
<td>离开队列</td>
</tr>
<tr>
<td><code>prepared</code></td>
<td><code>prompt_length</code>, <code>recording_session_id</code></td>
<td>准备完成</td>
</tr>
<tr>
<td><code>result</code></td>
<td><code>is_listen</code>, <code>text</code>, <code>audio_data</code>, <code>end_of_turn</code>, <code>cost_*_ms</code>, <code>kv_cache_length</code></td>
<td>单步结果</td>
</tr>
<tr>
<td><code>paused</code></td>
<td><code>timeout</code></td>
<td>暂停确认</td>
</tr>
<tr>
<td><code>resumed</code></td>
<td>—</td>
<td>恢复确认</td>
</tr>
<tr>
<td><code>stopped</code></td>
<td>—</td>
<td>已停止</td>
</tr>
<tr>
<td><code>timeout</code></td>
<td><code>reason</code></td>
<td>暂停超时</td>
</tr>
<tr>
<td><code>error</code></td>
<td><code>error</code></td>
<td>错误</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="_11">会话录制系统</h2>
<h3 id="sessionrecorder-wav">SessionRecorder（立体声 WAV）</h3>
<p>用于 Audio Duplex 模式，录制双声道 WAV 文件：
- <strong>左声道</strong>：用户音频（来自 AudioWorklet 采集的 PCM）
- <strong>右声道</strong>：AI 音频（来自 AudioPlayer 的 <code>onRawAudio</code> 回调）
- 精确时间对齐：基于 AudioContext 时间戳</p>
<h3 id="sessionvideorecorder">SessionVideoRecorder（视频 + 音频）</h3>
<p>用于 Omni 模式，录制视频 + 立体声音频：</p>
<p><strong>三层回退策略</strong>：
1. <code>videoEl.captureStream()</code> — 首选方案
2. <code>srcObject</code> 克隆 — Safari 兼容
3. Canvas <code>drawImage</code> 循环 — 字幕合成模式</p>
<p><strong>字幕合成</strong>：
- 通过 Canvas <code>drawImage</code> 绘制视频帧
- 在帧上叠加 AI 说话文本（字幕）
- 合成后的帧流传给 MediaRecorder</p>
<p><strong>音频混合</strong>：
- 使用 <code>stereo-recorder-processor.js</code> AudioWorklet
- 交织用户和 AI 音频为立体声</p>
<h3 id="recording-settingsjs">recording-settings.js</h3>
<p>录制设置面板，可配置：
- 视频格式（WebM / MP4）
- 视频质量
- 是否启用字幕
- 是否启用录制</p></article>
  <footer><p>MiniCPM-o 4.5 PyTorch Simple Demo &mdash; 由 build_docs.py 自动生成</p></footer>
</main>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/python.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/bash.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/json.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/javascript.min.js"></script>
<script type="module">
import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.esm.min.mjs';
mermaid.initialize({startOnLoad:true,theme:'default',securityLevel:'loose'});
</script>
<script>
hljs.highlightAll();
function toggleSidebar(){document.getElementById('sidebar').classList.toggle('open');document.getElementById('content').classList.toggle('shifted');}
document.querySelectorAll('.nav-group-header').forEach(function(h){h.addEventListener('click',function(){this.parentElement.classList.toggle('collapsed');});});
document.addEventListener('click',function(e){var s=document.getElementById('sidebar'),t=document.querySelector('.sidebar-toggle');if(window.innerWidth<=768&&s.classList.contains('open')&&!s.contains(e.target)&&!t.contains(e.target)){s.classList.remove('open');document.getElementById('content').classList.remove('shifted');}});
</script>
</body>
</html>
