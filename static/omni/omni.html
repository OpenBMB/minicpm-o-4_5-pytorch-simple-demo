<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MiniCPMO45 Omni Demo</title>
    <link rel="stylesheet" href="/static/duplex/duplex-shared.css">
    <link rel="stylesheet" href="/static/omni/omni.css">
</head>
<body>

<!-- ========== Header ========== -->
<div class="header">
    <div class="header-left">
        <h1>MiniCPM-o 4.5</h1>
        <div class="nav-links">
            <a href="/">Home</a>
            <a href="/omni" class="active">Omni Full-Duplex</a>
        </div>
    </div>
    <div class="header-right">
        <button class="header-reset-btn" id="btnResetSettings" data-tip="Clear all saved settings and restore defaults">Reset Settings</button>
        <span class="status-badge" id="serviceStatus">Connecting...</span>
    </div>
</div>

<!-- ========== Notice Banner ========== -->
<!-- <div class="notice-banner" id="noticeBanner">
    <span class="notice-icon">&#x1F3A7;</span>
    <span>Echo cancellation is currently limited. For the best experience — especially when interrupting the model while it is speaking — please use headphones. Contributions to improve this are welcome!</span>
    <button class="notice-dismiss" onclick="this.parentElement.style.display='none'" title="Dismiss">&times;</button>
</div> -->

<!-- ========== Two-Column Layout ========== -->
<div class="main">

    <!-- ===== Left Column ===== -->
    <div class="col-left">

    <div class="row-top">
    <!-- Video -->
    <div class="panel-media">
        <div class="video-container" id="videoContainer">
            <video id="videoEl" autoplay muted playsinline></video>
            <canvas id="frameCanvas" style="display:none;"></canvas>
            <div class="video-placeholder" id="videoPlaceholder">
                <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" style="opacity:0.5">
                    <path d="m22 8-6 4 6 4V8Z"/><rect width="14" height="12" x="2" y="6" rx="2" ry="2"/>
                </svg>
                <span>Camera loading...</span>
            </div>
            <div class="video-overlay" id="videoOverlay" style="display:none;">
                <span class="video-badge" id="modeBadge">Live</span>
            </div>
            <button class="cam-flip-btn" id="camFlipBtn" title="Flip camera">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M11 19H4a2 2 0 0 1-2-2V7a2 2 0 0 1 2-2h5"/><path d="M13 5h7a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2h-5"/>
                    <circle cx="12" cy="12" r="3"/><path d="m18 22-3-3 3-3"/><path d="m6 2 3 3-3 3"/>
                </svg>
            </button>
            <button class="mirror-btn" id="mirrorBtn" title="Mirror flip">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="12" y1="3" x2="12" y2="21" stroke-dasharray="2 2"/>
                    <polygon points="5,6 5,18 1,12" fill="currentColor" stroke="none"/>
                    <polygon points="19,6 19,18 23,12" fill="currentColor" stroke="none"/>
                    <path d="M8 6h-1a1 1 0 0 0-1 1v10a1 1 0 0 0 1 1h1"/>
                    <path d="M16 6h1a1 1 0 0 1 1 1v10a1 1 0 0 1-1 1h-1"/>
                </svg>
            </button>
            <div class="status-lamp" id="statusLamp">
                <span class="dot"></span><span class="label">LIVE</span><span class="timer" id="lampTimer"></span>
            </div>
            <button class="fullscreen-btn" id="fullscreenBtn" title="Fullscreen">
                <svg id="fullscreenIcon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M8 3H5a2 2 0 0 0-2 2v3"/><path d="M21 8V5a2 2 0 0 0-2-2h-3"/>
                    <path d="M3 16v3a2 2 0 0 0 2 2h3"/><path d="M16 21h3a2 2 0 0 0 2-2v-3"/>
                </svg>
            </button>
            <div class="video-border-overlay" id="videoBorderOverlay"></div>
            <button class="subtitle-toggle-btn" id="subtitleToggleBtn" title="Subtitles on/off">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M4 6h16"/><path d="M12 6v14"/>
                </svg>
            </button>
            <div class="fs-chat-overlay subtitle-on" id="fsChatOverlay">
                <div class="fs-chat-inner" id="fsChatInner"></div>
            </div>
            <div class="fullscreen-controls" id="fullscreenControls">
                <button class="fs-ctrl-btn" id="fsBtnForceListen" disabled style="background:rgba(255,255,255,0.15);color:#fff;">Force Listen</button>
                <button class="fs-ctrl-btn" id="fsBtnHD" disabled style="background:rgba(255,255,255,0.15);color:#fff;">HD</button>
                <button class="fs-ctrl-btn fs-start" id="fsBtnStart"><svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><polygon points="6,3 20,12 6,21"/></svg>Start</button>
                <button class="fs-ctrl-btn" id="fsBtnPause" disabled style="background:rgba(255,255,255,0.15);color:#fff;">Pause</button>
                <button class="fs-ctrl-btn fs-stop" id="fsBtnStop" disabled><svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor"><rect x="4" y="4" width="16" height="16" rx="2"/></svg>Stop</button>
            </div>
        </div>
    </div>
    <!-- Mode Selector (sidebar next to video) -->
    <div class="panel-mode" id="panelMode">
        <div class="fo-row fo-row-wrap">
            <div class="mode-selector">
                <button class="mode-btn active" data-mode="live" data-tip="Use camera and microphone for real-time input">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:-1px;margin-right:2px"><path d="m22 8-6 4 6 4V8Z"/><rect width="14" height="12" x="2" y="6" rx="2" ry="2"/></svg>Live
                </button>
                <button class="mode-btn" data-mode="file" data-tip="Use a pre-recorded video file as input">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:-1px;margin-right:2px"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/></svg>File
                </button>
            </div>
            <div class="file-chooser" id="fileChooser">
                <label for="videoFileInput" class="fo-file-btn" data-tip="Select a video file to send to the model">Choose video</label>
                <input type="file" id="videoFileInput" accept="video/*">
                <span class="file-name" id="fileName" data-tip="Current video file name">No file</span>
                <span class="fo-duration" id="fileDuration" data-tip="Video file duration"></span>
            </div>
        </div>
        <div class="file-options" id="fileOptions">
            <div class="fo-group">
                <span class="fo-group-title">Audio</span>
                <div class="fo-row fo-row-wrap">
                    <span class="fo-label" data-tip="Audio source sent to the model">Source</span>
                    <div class="fo-radio-group">
                        <label class="fo-radio" data-tip="Send only the video's audio track (no microphone)"><input type="radio" name="fileAudioMode" value="video" checked> Video-only</label>
                        <label class="fo-radio" data-tip="Send only microphone audio (ignore video audio)"><input type="radio" name="fileAudioMode" value="mic"> Mic-only</label>
                        <label class="fo-radio" data-tip="Mix video audio with microphone and send to the model"><input type="radio" name="fileAudioMode" value="mixed"> Video+Mic</label>
                    </div>
                </div>
                <div class="fo-row">
                    <span class="fo-label" data-tip="Playback volume of original video audio (speaker output only, does not affect audio sent to model)">Playback Volume</span>
                    <input type="range" class="fo-range" id="filePlaybackVol" min="0" max="100" value="30" step="5">
                    <span class="fo-val" id="filePlaybackVolVal">30%</span>
                </div>
                <button class="fo-mixer-btn" id="btnMixerToggle" style="display:none;" data-tip="Open draggable mixer panel">Mixer</button>
            </div>
            <div class="fo-group">
                <span class="fo-group-title">Video</span>
                <div class="fo-row fo-row-wrap">
                    <span class="fo-label" data-tip="Frame sample point within each second: 0=start, 0.5=middle, 1=end">Sample t</span>
                    <input type="range" class="fo-range" id="frameOffset" min="0" max="1" step="0.05" value="0.5">
                    <span class="fo-val" id="frameOffsetVal">0.50</span>
                </div>
                <div class="fo-row">
                    <span class="fo-label" data-tip="Padding: seconds of frozen frame + silence added before/after the video">Pad s</span>
                    <span style="font-size:10px;color:#888;" data-tip="Frozen frame + silence before video (seconds)">L</span>
                    <input type="number" class="cg-input-sm" id="padBeforeSec" value="0" min="0" max="30" step="1" data-tip="Frozen frame + silence before video (seconds)">
                    <span style="font-size:10px;color:#888;" data-tip="Frozen frame + silence after video (seconds)">R</span>
                    <input type="number" class="cg-input-sm" id="padAfterSec" value="2" min="0" max="30" step="1" data-tip="Frozen frame + silence after video (seconds)">
                </div>
            </div>
        </div>
    </div>
    </div><!-- /row-top -->

    <div class="row-bottom">
    <!-- Other Config -->
    <div class="panel-config">
        <details class="config-group" open>
            <summary>Session</summary>
            <div class="cg-body">
                <div class="cg-row inline" data-tip="Buffer before playback starts, higher = more stable but more latency">
                    <span class="cg-label" style="flex:none;">Delay</span>
                    <input type="number" class="cg-input-sm" id="playbackDelay" value="200" min="0" max="2000" step="50">
                    <span style="font-size:10px;color:#888;">ms</span>
                </div>
                <div class="cg-row inline" data-tip="Max KV cache size, limits conversation context length">
                    <span class="cg-label" style="flex:none;">MaxKV</span>
                    <input type="number" class="cg-input-sm" id="maxKvTokens" value="8192" min="512" max="131072" step="512">
                    <span style="font-size:10px;color:#888;">tok</span>
                </div>
                <div class="cg-row inline" data-tip="Controls AI response length, >1 = longer responses">
                    <span class="cg-label" style="flex:none;">Length Penalty</span>
                    <input type="number" class="cg-input-sm" id="omniLengthPenalty" value="1.05" min="0.1" max="5.0" step="0.05">
                    <span style="font-size:10px;color:#888;">&gt;1 = longer</span>
                </div>
                <div class="cg-row inline" data-tip="HD vision: 1 source + 2 slices = 192 tok/frame, better for text/details, +100ms latency">
                    <span class="cg-label" style="flex:none;">Vision HD</span>
                    <input type="checkbox" id="visionHD">
                    <span style="font-size:10px;color:#888;" id="visionHint">64 tok</span>
                </div>
            </div>
        </details>
        <details class="config-group" open>
            <summary>Fullscreen Subtitle</summary>
            <div class="cg-body">
                <div class="cg-row inline">
                    <span class="cg-label" style="flex:none;">Height</span>
                    <input type="number" class="cg-input-sm" id="fsSubHeight" value="20" min="5" max="80" step="5" style="width:50px;">
                    <span style="font-size:10px;color:#888;">% from bottom</span>
                </div>
                <div class="cg-row inline" data-tip="Subtitle background opacity gradient: bottom → top">
                    <span class="cg-label" style="flex:none;">Opacity %</span>
                    <input type="number" class="cg-input-sm" id="fsAlphaBottom" value="80" min="0" max="100" step="10" style="width:50px;">
                    <span style="font-size:13px;color:#888;">↗</span>
                    <input type="number" class="cg-input-sm" id="fsAlphaTop" value="30" min="0" max="100" step="10" style="width:50px;">
                </div>
            </div>
        </details>
    </div>

    <!-- Status -->
    <div class="panel-status" id="panelStatus"></div>
    </div><!-- /row-bottom -->

    </div><!-- /col-left -->

    <!-- ===== Right Column ===== -->
    <div class="col-right">

    <!-- Preset + System Prompt -->
    <div class="panel-sysconfig">
        <div style="padding:6px 0 8px 0;">
            <div id="presetSelectorOmni"></div>
        </div>
        <details class="config-group" id="omniSysPromptDetails">
            <summary style="display:none;">System Prompt Details</summary>
            <div class="cg-body">
                <div class="cg-row">
                    <textarea class="cg-input" id="systemPrompt" rows="2" placeholder="System prompt...">Streaming Omni Conversation.</textarea>
                </div>
                <div class="cg-row">
                    <span class="cg-label">LLM Ref Audio (system prompt)</span>
                    <div id="omniRefAudioPlayer"></div>
                </div>
                <div class="cg-row" style="margin-top:8px;padding-top:8px;border-top:1px solid #f0ede8;">
                    <span class="cg-label">TTS Ref Audio (voice cloning)</span>
                    <div style="font-size:12px;">
                        <div style="display:flex;gap:12px;align-items:center;margin-bottom:4px;">
                            <label style="cursor:pointer;color:#555;"><input type="radio" name="omniTtsRefMode" value="extract" checked> Same as LLM</label>
                            <label style="cursor:pointer;color:#555;"><input type="radio" name="omniTtsRefMode" value="independent"> Independent</label>
                        </div>
                        <div id="omniTtsRefHint" style="font-size:11px;color:#aaa;"></div>
                        <div id="omniTtsRefUpload" style="display:none;margin-top:6px;"></div>
                    </div>
                </div>
            </div>
        </details>
    </div>

    <!-- Dialog -->
    <div class="panel-dialog">
        <div class="conv-header">
            <span>Conversation</span>
        </div>
        <div class="conv-log" id="conversationLog">
            <div class="conv-empty" id="convEmpty">
                <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" style="opacity:0.4">
                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                </svg>
                <span>Start a session to see the conversation</span>
            </div>
        </div>
    </div>

    </div><!-- /col-right -->

    <!-- Controls (spans full width) -->
    <div class="panel-controls">
        <button class="ctrl-btn" id="btnForceListen" disabled data-tip="Force model into listening mode, interrupt speaking">Force Listen</button>
        <button class="ctrl-btn" id="btnHD" disabled data-tip="Toggle HD vision (3 slices, ~192 tok/frame, +100ms latency)">HD</button>
        <button class="ctrl-btn" id="btnPause" disabled data-tip="Pause/resume the duplex session without disconnecting">Pause</button>
        <button class="ctrl-btn danger" id="btnStop" disabled data-tip="Stop the session and disconnect">Stop</button>
        <button class="ctrl-btn primary" id="btnStart" data-tip="Start a new duplex session with camera and microphone">Start</button>
        <span class="ctrl-divider"></span>
        <label class="rec-label" data-tip="Record session as video with stereo audio (L=input mix, R=AI response)"><input type="checkbox" id="recCheckbox" checked> Rec</label>
        <button class="ctrl-btn rec-settings-btn" id="btnRecSettings" data-tip="Recording format &amp; quality settings">⚙</button>
        <button class="ctrl-btn" id="btnDownloadRec" style="display:none;" disabled data-tip="Download session recording">Download Rec</button>
    </div>

</div>

<!-- Draggable Mixer Panel (LUFS) — content injected by getMixerPanelHTML() -->
<div class="mixer-panel" id="mixerPanel"></div>

<!-- Save & Share -->
<div id="save-share-container" style="position:fixed;bottom:16px;right:16px;z-index:100;max-width:300px;"></div>

<script src="/static/ref-audio-player.js"></script>
<script src="/static/shared/preset-selector.js"></script>
<script src="/static/shared/save-share.js"></script>
<script type="module" src="/static/omni/omni-app.js"></script>
<script type="module">
import { initNav } from '/static/shared/app-nav.js';
initNav('omni');
</script>
</body>
</html>
